<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>通过demo学习OpenStack开发所需的基础知识 -- API服务(3)</title>
  <meta name="description" content="上一篇文章我们了解了一个巨啰嗦的框架：Paste + PasteDeploy + Routes + WebOb。后来OpenStack社区的人受不了这么啰嗦的代码了，决定换一个框架，他们最终选中了Pecan。Pecan框架相比上一篇文章的啰嗦框架有如下好处：">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/2015/09/30/learn-openstack-dev-skill-by-demo-04.html">
  <link rel="alternate" type="application/rss+xml" title="Coffee, Coke and Code" href="/feed.xml">
</head>


  <body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Coffee, Coke and Code</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">通过demo学习OpenStack开发所需的基础知识 -- API服务(3)</h1>
    <p class="post-meta"><time datetime="2015-09-30T00:00:00+08:00" itemprop="datePublished">Sep 30, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>上一篇文章我们了解了一个巨啰嗦的框架：Paste + PasteDeploy + Routes + WebOb。后来OpenStack社区的人受不了这么啰嗦的代码了，决定换一个框架，他们最终选中了<strong>Pecan</strong>。Pecan框架相比上一篇文章的啰嗦框架有如下好处：</p>

<ul>
  <li>不用自己写WSGI application了</li>
  <li>请求路由很容易就可以实现了</li>
</ul>

<p>总的来说，用上Pecan框架以后，很多重复的代码不用写了，开发人员可以专注于业务，也就是实现每个API的功能。</p>

<h1 id="pecan">Pecan</h1>

<p>Pecan框架的目标是实现一个采用对象分发方式进行URL路由的轻量级Web框架。它非常专注于自己的目标，它的大部分功能都和URL路由以及请求和响应的处理相关，而不去实现模板、安全以及数据库层，这些东西都可以通过其他的库来实现。关于Pecan的更多信息，可以查看文档：<a href="https://pecan.readthedocs.org/en/latest/index.html">https://pecan.readthedocs.org/en/latest/index.html</a>。本文以OpenStack的magnum项目为例来说明Pecan项目在实际中的应用，但是本文不会详细讲解Pecan的各个方面，一些细节请读者阅读Pecan的文档。</p>

<h2 id="项目中的代码结构">项目中的代码结构</h2>

<p>使用Pecan框架时，OpenStack项目一般会把API服务的实现都放在一个<strong>api</strong>目录下，比如magnum项目是这样的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ ~/openstack/env/p/magnum git:(master) $ tree magnum/api
magnum/api
├── app.py
├── auth.py
├── config.py
├── controllers
│   ├── base.py
│   ├── __init__.py
│   ├── link.py
│   ├── root.py
│   └── v1
│       ├── base.py
│       ├── baymodel.py
│       ├── bay.py
│       ├── certificate.py
│       ├── collection.py
│       ├── container.py
│       ├── __init__.py
│       ├── magnum_services.py
│       ├── node.py
│       ├── pod.py
│       ├── replicationcontroller.py
│       ├── service.py
│       ├── types.py
│       ├── utils.py
│       └── x509keypair.py
├── expose.py
├── hooks.py
├── __init__.py
├── middleware
│   ├── auth_token.py
│   ├── __init__.py
│   └── parsable_error.py
├── servicegroup.py
└── validation.py
</code></pre>
</div>

<p>你也可以在Ceilometer项目中看到类似的结构。介绍一下几个主要的文件，这样你以后看到一个使用Pecan的OpenStack项目时就会比较容易找到入口。</p>

<ul>
  <li>app.py  一般包含了Pecan应用的入口，包含应用初始化代码</li>
  <li>config.py  包含Pecan的应用配置，会被app.py使用</li>
  <li>controllers/  这个目录会包含所有的控制器，也就是API具体逻辑的地方</li>
  <li>controllers/root.py  这个包含根路径对应的控制器</li>
  <li>controllers/v1/   这个目录对应v1版本的API的控制器。如果有多个版本的API，你一般能看到v2等目录。</li>
</ul>

<h2 id="代码变少了application的配置">代码变少了：application的配置</h2>

<p>Pecan的配置很容易，通过一个Python源码式的配置文件就可以完成基本的配置。这个配置的主要目的是指定应用程序的root，然后用于生成WSGI application。我们来看Magnum项目的例子。Magnum项目有个API服务是用Pecan实现的，在<em>magnum/api/config.py</em>文件中可以找到这个文件，主要内容如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">app</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'root'</span><span class="p">:</span> <span class="s">'magnum.api.controllers.root.RootController'</span><span class="p">,</span>
    <span class="s">'modules'</span><span class="p">:</span> <span class="p">[</span><span class="s">'magnum.api'</span><span class="p">],</span>
    <span class="s">'debug'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">'hooks'</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">hooks</span><span class="o">.</span><span class="n">ContextHook</span><span class="p">(),</span>
        <span class="n">hooks</span><span class="o">.</span><span class="n">RPCHook</span><span class="p">(),</span>
        <span class="n">hooks</span><span class="o">.</span><span class="n">NoExceptionTracebackHook</span><span class="p">(),</span>
    <span class="p">],</span>
    <span class="s">'acl_public_routes'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'/'</span>
    <span class="p">],</span>
<span class="p">}</span></code></pre></figure>

<p>上面这个<strong>app</strong>对象就是Pecan的配置，每个Pecan应用都需要有这么一个名为app的配置。app配置中最主要的就是<strong>root</strong>的值，这个值表示了应用程序的入口，也就是从哪个地方开始解析HTTP的根path：<strong>/</strong>。<strong>hooks</strong>对应的配置是一些Pecan的hook，作用类似于WSGI Middleware。</p>

<p>有了app配置后，就可以让Pecan生成一个WSGI application。在Magnum项目中，<em>magnum/api/app.py</em>文件就是生成WSGI application的地方，我们来看一下这个的主要内容：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_pecan_config</span><span class="p">():</span>
    <span class="c"># Set up the pecan configuration</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">api_config</span><span class="o">.</span><span class="n">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.pyc'</span><span class="p">,</span> <span class="s">'.py'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pecan</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">conf_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">setup_app</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_pecan_config</span><span class="p">()</span>

    <span class="n">app_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">make_app</span><span class="p">(</span>
        <span class="n">app_conf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'root'</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">'logging'</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="n">wrap_app</span><span class="o">=</span><span class="n">middleware</span><span class="o">.</span><span class="n">ParsableErrorMiddleware</span><span class="p">,</span>
        <span class="o">**</span><span class="n">app_conf</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">auth</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">CONF</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">acl_public_routes</span><span class="p">)</span></code></pre></figure>

<p><code class="highlighter-rouge">get_pecan_config()</code>方法读取我们上面提到的config.py文件，然后返回一个<strong>pecan.configuration.Config</strong>对象。<code class="highlighter-rouge">setup_app()</code>函数首先调用<code class="highlighter-rouge">get_pecan_config()</code>函数获取application的配置，然后调用<code class="highlighter-rouge">pecan.make_app()</code>函数创建了一个WSGI application，最后调用了 <code class="highlighter-rouge">auth.install()</code>函数（也就是magnum.api.auth.install()函数）为刚刚生成的WSGI application加上Keystone的认证中间件（确保所有的请求都会通过Keystone认证）。</p>

<p>到这边为止，一个Pecan的WSGI application就已经准备好了，只要调用这个<code class="highlighter-rouge">setup_app()</code>函数就能获得。至于如何部署这个WSGI application，请参考<a href="http://segmentfault.com/a/1190000003069785">WSGI简介</a>这篇文章。</p>

<p>从Magnum这个实际的例子可以看出，使用了Pecan之后，我们不再需要自己写那些冗余的WSGI application代码了，直接调用Pecan的<code class="highlighter-rouge">make_app()</code>函数就能完成这些工作。另外，对于之前使用PasteDeploy时用到的很多WSGI中间件，可以选择使用Pecan的hooks机制来实现，也选择使用WSGI中间件的方式来实现。在Magnum的API服务就同时使用了这两种方式。其实，Pecan还可以和PasteDeploy一起使用，Ceilometer项目就是这么做的，大家可以看看。</p>

<h2 id="确定路由变得容易了对象分发式的路由">确定路由变得容易了：对象分发式的路由</h2>

<p>Pecan不仅缩减了生成WSGI application的代码，而且也让开发人员更容易的指定一个application的路由。Pecan采用了一种对象分发风格（<strong>object-dispatch style</strong>）的路由模式。我们直接通过例子来解释这种路由模式，还是以Magnum项目为例。</p>

<p>上面提到了，Magnum的API服务的root是<strong>magnum.api.controllers.root.RootController</strong>。这里的RootController的是一个类，我们来看它的代码：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="n">_versions</span> <span class="o">=</span> <span class="p">[</span><span class="s">'v1'</span><span class="p">]</span>
    <span class="s">"""All supported API versions"""</span>

    <span class="n">_default_version</span> <span class="o">=</span> <span class="s">'v1'</span>
    <span class="s">"""The default API version"""</span>

    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">Controller</span><span class="p">()</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Root</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># NOTE: The reason why convert() it's being called for every</span>
        <span class="c">#       request is because we need to get the host url from</span>
        <span class="c">#       the request object to make the links.</span>
        <span class="k">return</span> <span class="n">Root</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

    <span class="nd">@pecan.expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="s">"""Overrides the default routing behavior.

        It redirects the request to the default version of the magnum API
        if the version number is not specified in the url.
        """</span>

        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_versions</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_version</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RootController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_route</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code></pre></figure>

<p>别看这个类这么长，我来解释一下你就懂了。首先，你可以先忽略掉<code class="highlighter-rouge">_route()</code>函数，这个函数是用来覆盖Pecan的默认路由实现的，在这里去掉它不妨碍我们理解Pecan（这里的<code class="highlighter-rouge">_route()</code>函数的作用把所有请求重定向到默认的API版本去）。去掉<code class="highlighter-rouge">_route()</code>和其他的东西后，整个类就变成这么短：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">Controller</span><span class="p">()</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Root</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Root</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span></code></pre></figure>

<ul>
  <li>首先，你要记住，这个<em>RootController</em>对应的是URL中根路径，也就是path中最左边的<strong>/</strong>。</li>
  <li><em>RootController</em>继承自<em>rest.RestController</em>，是Pecan实现的RESTful控制器。这里的<code class="highlighter-rouge">get()</code>函数表示，当访问的是<em>GET /</em>时，由该函数处理。<code class="highlighter-rouge">get()</code>函数会返回一个WSME对象，表示一个形式化的HTTP Response，这个下面再讲。<code class="highlighter-rouge">get()</code>函数上面的<code class="highlighter-rouge">expose</code>装饰器是Pecan实现路由控制的一个方式，被expose的函数才会被路由处理。</li>
  <li>这里的<code class="highlighter-rouge">v1 = v1.Controller()</code>表示，当访问的是<em>GET /v1</em>或者<em>GET /v1/…</em>时，请求由一个<code class="highlighter-rouge">v1.Controller</code>实例来处理。</li>
</ul>

<p>为了加深大家的理解，我们再来看下<code class="highlighter-rouge">v1.Controller</code>的实现：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Controller</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="s">"""Version 1 API controller root."""</span>

    <span class="n">bays</span> <span class="o">=</span> <span class="n">bay</span><span class="o">.</span><span class="n">BaysController</span><span class="p">()</span>
    <span class="n">baymodels</span> <span class="o">=</span> <span class="n">baymodel</span><span class="o">.</span><span class="n">BayModelsController</span><span class="p">()</span>
    <span class="n">containers</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">ContainersController</span><span class="p">()</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">NodesController</span><span class="p">()</span>
    <span class="n">pods</span> <span class="o">=</span> <span class="n">pod</span><span class="o">.</span><span class="n">PodsController</span><span class="p">()</span>
    <span class="n">rcs</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">ReplicationControllersController</span><span class="p">()</span>
    <span class="n">services</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">ServicesController</span><span class="p">()</span>
    <span class="n">x509keypairs</span> <span class="o">=</span> <span class="n">x509keypair</span><span class="o">.</span><span class="n">X509KeyPairController</span><span class="p">()</span>
    <span class="n">certificates</span> <span class="o">=</span> <span class="n">certificate</span><span class="o">.</span><span class="n">CertificateController</span><span class="p">()</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">V1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">V1</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

    <span class="o">...</span></code></pre></figure>

<p>上面这个Controller也是继承自<em>rest.RestController</em>。所以它的<em>get</em>函数表示，当访问的是<em>GET /v1</em>的时候，要做的处理。然后，它还有很多类属性，这些属性分别表示不同URL路径的控制器：</p>

<ul>
  <li>/v1/bays 由bays处理</li>
  <li>/v1/baymodels 由baymodels处理</li>
  <li>/v1/containers 由containers处理</li>
</ul>

<p>其他的都是类似的。我们再继续看<code class="highlighter-rouge">bay.BaysController</code>的代码：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">BaysController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="s">"""REST controller for Bays."""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaysController</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'detail'</span><span class="p">:</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">detail</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">get_one</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="o">...</span><span class="p">):</span></code></pre></figure>

<p>这个controller中只有函数，没有任何类属性，而且没有实现任何特殊方法，所以<em>/v1/bays</em>开头的URL处理都在这个controller中终结。这个类会处理如下请求：</p>

<ul>
  <li>GET /v1/bays</li>
  <li>GET /v1/bays/{UUID}</li>
  <li>POST /v1/bays</li>
  <li>PATCH /v1/bays/{UUID}</li>
  <li>DELETE /v1/bays/{UUID}</li>
  <li>GET /v1/bays/detail/{UUID}</li>
</ul>

<p>看了上面的3个controller之后，你应该能大概明白Pecan是如何对URL进行路由的。这种路由方式就是对象分发：<strong>根据类属性，包括数据属性和方法属性来决定如何路由一个HTTP请求</strong>。Pecan的文档中对请求的路由有专门的描述，要想掌握Pecan的路由还是要完整的看一下官方文档。</p>

<h2 id="内置restful支持">内置RESTful支持</h2>

<p>我们上面举例的controller都是继承自<code class="highlighter-rouge">pecan.rest.RestController</code>，这种controller称为<strong>RESTful controller</strong>，专门用于实现RESTful API的，因此在OpenStack中使用特别多。Pecan还支持普通的controller，称为<strong>Generic controller</strong>。Generic controller继承自object对象，默认没有实现对RESTful请求的方法。简单的说，RESTful controller帮我们规定好了<code class="highlighter-rouge">get_one()</code>, <code class="highlighter-rouge">get_all()</code>, <code class="highlighter-rouge">get()</code>, <code class="highlighter-rouge">post()</code>等方法对应的HTTP请求，而Generic controller则没有。关于这两种controller的区别，可以看官方文档<a href="https://pecan.readthedocs.org/en/latest/rest.html">Writing RESTful Web Services with Generic Controllers</a>，有很清楚的示例。</p>

<p>对于RestController中没有预先定义好的方法，我们可以通过控制器的<code class="highlighter-rouge">_custom_actions</code>属性来指定其能处理的方法。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'test'</span><span class="p">:</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'hello'</span></code></pre></figure>

<p>上面这个控制器是一个根控制器，指定了/test路径支持GET方法，效果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code> $ curl http://localhost:8080/test
hello% 
</code></pre>
</div>

<h2 id="那么http请求和http响应呢">那么HTTP请求和HTTP响应呢？</h2>

<p>上面讲了这么多，我们都没有说明在Pecan中如何处理请求和如何返回响应。这个将在下一章中说明，同时我们会引入一个新的库<strong>WSME</strong>。</p>

<h1 id="wsme">WSME</h1>

<h2 id="pecan对请求和响应的处理">Pecan对请求和响应的处理</h2>

<p>在开始提到WSME之前，我们先来看下Pecan自己对HTTP请求和响应的处理。这样你能更好的理解为什么会再引入一个WSME库。</p>

<p>Pecan框架为每个线程维护了单独的请求和响应对象，你可以直接在请求处理函数中访问。<strong>pecan.request</strong>和<strong>pecan.response</strong>分别代表当前需要处理的请求和响应对象。你可以直接操作这两个对象，比如指定响应的状态码，就像下面这个例子一样（例子来自官方文档）：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@pecan.expose</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s">'/login'</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'password'</span><span class="p">)</span>

    <span class="n">pecan</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">403</span>
    <span class="n">pecan</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">'Bad Login!'</span></code></pre></figure>

<p>这个例子演示了访问POST请求的参数以及返回403。你也可以重新构造一个<code class="highlighter-rouge">pecan.Response</code>对象作为返回值（例子来自官方文档）：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pecan</span> <span class="kn">import</span> <span class="n">expose</span><span class="p">,</span> <span class="n">Response</span>

<span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'Hello, World!'</span><span class="p">,</span> <span class="mi">202</span><span class="p">)</span></code></pre></figure>

<p>另外，HTTP请求的参数也会可以作为控制器方法的参数，还是来看几个官方文档的例子：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg</span>

    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span></code></pre></figure>

<p>这个控制器中的方法直接返回了参数，演示了对GET请求参数的处理，效果是这样的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl http://localhost:8080/?arg=foo
foo
$ curl http://localhost:8080/kwargs?a=1&amp;b=2&amp;c=3
{u'a': u'1', u'c': u'3', u'b': u'2'}
</code></pre>
</div>

<p>有时候，参数也可能是URL的一部分，比如最后的一段path作为参数，就像下面这样：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code></pre></figure>

<p>效果是这样的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl http://localhost:8080/args/one/two/three
one,two,three
</code></pre>
</div>

<p>另外，我们还要看一下POST方法的参数如何处理（例子来自官方文档）：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arg</span></code></pre></figure>

<p>效果如下，就是把HTTP body解析成了控制器方法的参数：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl -X POST "http://localhost:8080/" -H "Content-Type: application/x-www-form-urlencoded" -d "arg=foo"
foo
</code></pre>
</div>

<h2 id="返回json还是html">返回JSON还是HTML？</h2>

<p>如果你不是明确的返回一个Response对象，那么Pecan中方法的返回内容类型就是由<code class="highlighter-rouge">expose()</code>装饰器决定的。默认情况下，控制器的方法返回的content-type是HTML。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'test'</span><span class="p">:</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="nd">@expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'hello'</span></code></pre></figure>

<p>效果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code> $ curl -v http://localhost:8080/test
* Hostname was NOT found in DNS cache
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET /test HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Tue, 15 Sep 2015 14:31:28 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.9
&lt; Content-Length: 5
&lt; Content-Type: text/html; charset=UTF-8
&lt;
* Closing connection 0
hello% 
</code></pre>
</div>

<p>也可以让它返回JSON：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'test'</span><span class="p">:</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="nd">@expose</span><span class="p">(</span><span class="s">'json'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'hello'</span></code></pre></figure>

<p>效果如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code> curl -v http://localhost:8080/test
* Hostname was NOT found in DNS cache
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET /test HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Tue, 15 Sep 2015 14:33:27 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.9
&lt; Content-Length: 18
&lt; Content-Type: application/json; charset=UTF-8
&lt;
* Closing connection 0
{"hello": "world"}% 
</code></pre>
</div>

<p>甚至，你还可以让一个控制器方法根据URL path的来决定是返回HTML还是JSON：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'test'</span><span class="p">:</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="nd">@expose</span><span class="p">()</span>
    <span class="nd">@expose</span><span class="p">(</span><span class="s">'json'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">'hello'</span><span class="p">:</span> <span class="s">'world'</span><span class="p">})</span></code></pre></figure>

<p>返回JSON：</p>
<div class="highlighter-rouge"><pre class="highlight"><code> $ curl -v http://localhost:8080/test.json
* Hostname was NOT found in DNS cache
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET /test.json HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Wed, 16 Sep 2015 14:26:27 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.9
&lt; Content-Length: 24
&lt; Content-Type: application/json; charset=UTF-8
&lt;
* Closing connection 0
"{\"hello\": \"world\"}"% 
</code></pre>
</div>

<p>返回HTML：</p>
<div class="highlighter-rouge"><pre class="highlight"><code> $ curl -v http://localhost:8080/test.html
* Hostname was NOT found in DNS cache
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET /test.html HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Wed, 16 Sep 2015 14:26:24 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.9
&lt; Content-Length: 18
&lt; Content-Type: text/html; charset=UTF-8
&lt;
* Closing connection 0
{"hello": "world"}% 
</code></pre>
</div>

<p>这里要注意一下：</p>

<ol>
  <li>同一个字符串作为JSON返回和作为HTML返回是不一样的，仔细看一下HTTP响应的内容。</li>
  <li>我们的例子中在URL的最后加上了<strong>.html</strong>后缀或者<strong>.json</strong>后缀，请尝试一下不加后缀的化是返回什么？然后，调换一下两个<code class="highlighter-rouge">expose()</code>的顺序再试一下。</li>
</ol>

<p>从上面的例子可以看出，决定响应类型的主要是传递给<code class="highlighter-rouge">expose()</code>函数的参数，我们看下<code class="highlighter-rouge">expose()</code>函数的完整声明：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">pecan</span><span class="o">.</span><span class="n">decorators</span><span class="o">.</span><span class="n">expose</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">content_type</span><span class="o">=</span><span class="s">'text/html'</span><span class="p">,</span>
                        <span class="n">generic</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></figure>

<ul>
  <li><strong>template</strong>参数用来指定返回值的模板，如果是’json’就会返回JSON内容，这里可以指定一个HTML文件，或者指定一个mako模板。</li>
  <li><strong>content_type</strong>指定响应的content-type，默认值是’text/html’。</li>
  <li><strong>generic</strong>参数表明该方法是一个“泛型”方法，可以指定多个不同的函数对应同一个路径的不同的HTTP方法。</li>
</ul>

<p>看过参数的解释后，你应该能大概了解<code class="highlighter-rouge">expose()</code>函数是如何控制HTTP响应的内容和类型的。</p>

<h2 id="用wsme来做什么">用WSME来做什么？</h2>

<p>上面两节已经说明了Pecan可以比较好的处理HTTP请求中的参数以及控制HTTP返回值。那么为什么我们还需要WSME呢？因为Pecan在做下面这个事情的时候比较麻烦：<strong>请求参数和响应内容的类型检查</strong>（英文简称就是<strong>typing</strong>）。当然，做是可以做的，不过你需要自己访问pecan.request和pecan.response，然后检查指定的值的类型。WSME就是为解决这个问题而生的，而且适用场景就是RESTful API。</p>

<h2 id="wsme简介">WSME简介</h2>

<p>WSME的全称是<strong>Web Service Made Easy</strong>，是专门用于实现REST服务的typing库，让你不需要直接操作请求和响应，而且刚好和Pecan结合得非常好，所以OpenStack的很多项目都使用了Pecan + WSME的组合来实现API（好吧，我看过的项目，用了Pecan的都用了WSME）。WSME的理念是：在大部分情况下，Web服务的输入和输出对数据类型的要求都是严格的。所以它就专门解决了这个事情，然后把其他事情都交给其他框架去实现。因此，一般WSME都是和其他框架配合使用的，支持Pecan、Flask等。WSME的文档地址是<a href="http://wsme.readthedocs.org/en/latest/index.html">http://wsme.readthedocs.org/en/latest/index.html</a>。</p>

<h2 id="wsme的使用">WSME的使用</h2>

<p>用了WSME后的好处是什么呢？WSME会自动帮你检查HTTP请求和响应中的数据是否符合预先设定好的要求。WSME的主要方式是通过装饰器来控制controller方法的输入和输出。WSME中主要使用两个控制器：</p>

<ul>
  <li><strong>@signature</strong>: 这个装饰器用来描述一个函数的输入和输出。</li>
  <li><strong>@wsexpose</strong>: 这个装饰器包含@signature的功能，同时会把函数的路由信息暴露给Web框架，效果就像Pecan的expose装饰器。</li>
</ul>

<p>这里我们结合Pecan来讲解WSME的使用。先来看一个原始类型的例子：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">wsmeext.pecan</span> <span class="kn">import</span> <span class="n">wsexpose</span>

<span class="k">class</span> <span class="nc">RootController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>
    <span class="n">_custom_actions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'test'</span><span class="p">:</span> <span class="p">[</span><span class="s">'GET'</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="nd">@wsexpose</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">number</span></code></pre></figure>

<p>如果不提供参数，访问会失败：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl http://localhost:8080/test
{"debuginfo": null, "faultcode": "Client", "faultstring": "Missing argument: \"number\""}% 
</code></pre>
</div>

<p>如果提供的参数不是整型，访问也会失败：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl http://localhost:8080/test\?number\=a
{"debuginfo": null, "faultcode": "Client", "faultstring": "Invalid input for field/attribute number. Value: 'a'. unable to convert to int"}% 
</code></pre>
</div>

<p>上面这些错误信息都是由WSME框架直接返回的，还没有执行到你写的方法。如果请求正确，那么会是这样的：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ curl -v http://localhost:8080/test\?number\=1
* Hostname was NOT found in DNS cache
*   Trying 127.0.0.1...
* Connected to localhost (127.0.0.1) port 8080 (#0)
&gt; GET /test?number=1 HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Wed, 16 Sep 2015 15:06:35 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.9
&lt; Content-Length: 1
&lt; Content-Type: application/json; charset=UTF-8
&lt;
* Closing connection 0
1% 
</code></pre>
</div>

<p>请注意返回的content-type,这里返回JSON是因为我们使用的<code class="highlighter-rouge">wsexpose</code>设置的返回类型是XML和JSON，并且JSON是默认值。上面这个例子就是WSME最简单的应用了。</p>

<p>那么现在有下面这些问题需要思考一下：</p>

<ul>
  <li>如果想用POST的方式来传递参数，要怎么做呢？提示：要阅读WSME中@signature装饰器的文档。</li>
  <li>如果我希望使用<em>/test/1</em>这种方式来传递参数要怎么做呢？提示：要阅读Pecan文档中关于路由的部分。</li>
  <li>WSME中支持对哪些类型的检查呢？WSME支持整型、浮点型、字符串、布尔型、日期时间等，甚至还支持用户自定义类型。提示：要阅读WSME文档中关于类型的部分。</li>
  <li>WSME支持数组类型么？支持。</li>
</ul>

<p>上面的问题其实也是很多人使用WSME的时候经常问的问题。我们将在下一篇文章中使用Pecan + WSME来继续开发我们的demo，并且用代码来回答上面所有的问题。</p>


    <br />
    <div>
      <!-- aThis Button BEGIN -->
      <div class="jiathis_style_32x32">
        <a class="jiathis_button_tsina"></a>
        <a class="jiathis_button_twitter"></a>
        <a class="jiathis_button_googleplus"></a>
        <a class="jiathis_button_weixin"></a>
        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
      </div>
      <script type="text/javascript" >
var jiathis_config={
  sm:"tsina,weixin,twitter,googleplus",
  summary:"",
  shortUrl:false,
  hideMore:true
}
      </script>
      <script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
      <!-- JiaThis Button END -->
    </div>
    <div>
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。
    </div>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Coffee, Coke and Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Coffee, Coke and Code</li>
          <li><a href="mailto:diabloneo@gmail.com">diabloneo@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/diabloneo"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">diabloneo</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/diabloneo"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">diabloneo</span></a>

          </li>
          

          
          <li>
            <a href="https://weibo.com/diabloneo"><span class="icon icon--weibo"><?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1506693756610" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1461" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M36.795021 82.536808 36.795021 82.536808 36.795021 82.536808Z" p-id="1462"></path><path d="M704.237279 523.521404c-9.210779-1.846044-15.190981-4.604878-17.941628-8.278547-2.749624-3.672646-3.210112-7.05058-1.384533-10.133801l2.769067-4.595668c0.607844-0.608867 1.226944-1.530866 1.855254-2.769067 0.62831-1.237177 1.855254-3.848655 3.682879-7.835456 1.826602-3.987824 3.211135-7.973602 4.1536-11.961426 0.942465-3.986801 1.708921-8.895601 2.297322-14.728446 0.589424-5.832845 0.431835-11.361769-0.470721-16.58677-0.903579-5.225001-2.749624-10.900258-5.539156-17.027815-2.790556-6.127558-6.628978-11.656481-11.519358-16.585747-8.601912-8.601912-19.806091-14.129812-33.613562-16.585747-13.807471-2.454912-27.613918-2.611477-41.421388-0.470721-13.806447 2.142803-26.847461 4.901637-39.122019 8.278547-12.274558 3.377934-22.398126 6.598278-30.372751 9.664104l-11.960403 5.538133c-6.147 1.846044-11.213389 3.074012-15.201214 3.682879-3.987824 0.60989-7.060813 0.453325-9.219989-0.470721-2.160199-0.923022-3.848655-1.846044-5.068436-2.768043-1.218758-0.923022-1.680269-3.072989-1.384533-6.451946 0.296759-3.377934 0.599657-6.294356 0.912789-8.749268 0.313132-2.452865 1.078565-6.293333 2.297322-11.519358 1.217734-5.226025 2.14178-9.369392 2.768043-12.432147 0-7.364735-0.461511-14.267958-1.384533-20.709671-0.923022-6.441713-2.916423-13.649881-5.981225-21.623483-3.063779-7.973602-7.512091-14.415314-13.345959-19.326161-5.833869-4.910846-13.198603-8.896624-22.095227-11.960403-8.896624-3.063779-20.406772-3.986801-34.527374-2.769067-14.121626 1.218758-30.079062 4.900613-47.873334 11.04659-21.485337 7.364735-43.275619 18.254759-65.369823 32.67212-22.094204 14.415314-41.273009 29.449729-57.534368 45.101197-16.261359 15.652492-31.149441 30.843472-44.661176 45.573965-13.511735 14.731516-23.950482 26.701129-31.315216 35.912931l-10.133801 14.728446c-20.249183 26.397207-35.282574 52.79339-45.102221 79.187527-9.819646 26.396183-14.424524 46.340421-13.81668 59.83476l0 19.326161c3.693112 29.458939 12.746302 55.855122 27.161616 79.187527 14.415314 23.331381 31.599695 42.205241 51.55519 56.620555 19.955494 14.415314 43.434232 26.689872 70.437236 36.82572 27.004027 10.133801 52.937676 17.498536 77.804017 22.095227 24.864294 4.595668 51.103912 7.816013 78.716806 9.664104 45.426609 3.692089 92.533486 0.166799 141.317563-10.57587 48.786123-10.744715 94.202499-29.313629 136.25322-55.708789 42.049698-26.396183 71.666226-58.006112 88.849584-94.830809 10.429537-21.48636 15.800871-41.74373 16.116049-60.776202 0.315178-19.031449-2.907213-34.527374-9.664104-46.486754-6.756891-11.960403-15.507182-22.546505-26.248827-31.758308-10.741645-9.211802-20.866237-15.968693-30.372751-20.268626-9.506515-4.299933-17.941628-7.059789-25.305339-8.278547L704.237279 523.521404 704.237279 523.521404zM423.455361 809.841455c-66.284659 3.064802-122.592083-9.829879-168.924317-38.680974-46.330188-28.851095-69.495794-65.370847-69.494771-109.561301 0-43.579541 23.01825-81.170694 69.053726-112.772436 46.036499-31.600719 102.500489-48.942689 169.394015-52.02591 66.893526-3.082198 123.358539 7.964392 169.392992 33.141818 46.036499 25.177426 69.053726 59.546188 69.053726 103.108333 0 44.190455-23.478737 83.931574-70.438259 119.224382-46.958498 35.291784-102.962 54.470589-168.009482 57.533344L423.455361 809.841455 423.455361 809.841455zM396.765489 554.806945c-17.793248 1.846044-33.750685 5.990434-47.873334 12.432147-14.121626 6.442736-25.168216 13.807471-33.140795 22.095227-7.972579 8.28878-14.728446 17.185404-20.268626 26.689872-5.539156 9.505491-9.378601 18.86465-11.519358 28.075429-2.140757 9.210779-3.524267 17.646915-4.1536 25.306362-0.630357 7.659447-0.933255 13.638625-0.913812 17.940604l0.913812 7.365758 0 3.682879c0 1.846044 0.618077 5.5279 1.855254 11.04659 1.237177 5.519714 2.925632 10.587126 5.067412 15.202237 2.14178 4.615111 5.66707 9.682523 10.57587 15.201214 4.909823 5.51869 10.743692 10.124592 17.499559 13.81668 40.517809 19.639293 78.264505 25.619494 113.243157 17.940604 34.977629-7.67889 63.209624-25.324782 84.695984-52.937676 8.601912-10.428513 14.278191-23.322172 17.028838-38.680974s2.131547-30.853705-1.855254-46.486754c-3.987824-15.634072-10.891048-29.90203-20.709671-42.805922-9.818623-12.902868-24.39255-22.880103-43.719734-29.930683-19.326161-7.05058-41.577954-9.045003-66.756403-5.981225L396.765489 554.806945 396.765489 554.806945zM363.621625 728.827327c-3.692089 0.607844-7.217379 0.765433-10.57587 0.470721-3.358491-0.293689-6.431479-0.913812-9.219989-1.855254-2.789533-0.941442-5.548366-2.01182-8.278547-3.210112-2.729158-1.197268-5.027503-2.885723-6.892991-5.067412-1.864464-2.180666-3.553942-4.331655-5.067412-6.451946-1.51347-2.12029-2.741437-4.576225-3.682879-7.364735-0.942465-2.790556-1.403976-5.705955-1.384533-8.749268 0-6.756891 1.846044-13.355169 5.538133-19.796882 3.692089-6.441713 8.759501-11.970636 15.201214-16.58677 6.441713-4.615111 13.649881-7.227612 21.624507-7.836479 5.51869-0.607844 10.890025-0.451278 16.115026 0.471744 5.225001 0.921999 9.673313 2.453888 13.345959 4.595668 3.672646 2.14178 6.894014 4.596691 9.664104 7.365758 2.77009 2.768043 4.76349 5.989411 5.981225 9.66308 1.216711 3.674693 1.835811 7.661494 1.855254 11.961426 0 6.755868-1.9934 13.19758-5.981225 19.325138-3.986801 6.128581-9.358135 11.343349-16.115026 15.643282-6.756891 4.299933-14.121626 6.755868-22.095227 7.365758L363.621625 728.827327 363.621625 728.827327zM441.86771 662.542668c-4.300956 3.063779-8.750291 4.448312-13.346983 4.1536-4.595668-0.294712-7.816013-2.288113-9.66308-5.981225l-1.856277-3.682879c-0.607844-1.237177-0.912789-2.465145-0.912789-3.682879l0-3.682879c0-1.846044 0.304945-3.377934 0.912789-4.596691l1.856277-3.682879c0.607844-1.237177 1.530866-2.160199 2.768043-2.768043l2.768043-3.682879c4.910846-3.693112 9.664104-5.225001 14.258749-4.596691 4.595668 0.629333 7.816013 3.084245 9.664104 7.365758 1.845021 2.454912 2.610454 5.214768 2.296299 8.278547-0.314155 3.063779-1.237177 5.980201-2.768043 8.749268-1.531889 2.769067-3.52529 5.380544-5.981225 7.835456L441.86771 662.542668 441.86771 662.542668zM768.695337 470.110961c3.692089 0 7.071046-0.923022 10.133801-2.769067 3.063779-1.845021 5.51869-4.143367 7.364735-6.891967 1.847068-2.750647 3.075035-5.66707 3.682879-8.749268 0.608867-0.608867 0.913812-1.531889 0.913812-2.769067 7.363711-69.976748-17.186428-109.874433-73.650417-119.695103-16.576537-3.063779-31.925107-3.367701-46.045709-0.912789-4.300956 0-7.983835 1.070378-11.04659 3.210112-3.063779 2.140757-5.676279 4.898567-7.836479 8.278547-2.160199 3.377934-3.230578 6.904247-3.210112 10.57587 0 6.147 2.15099 11.360745 6.451946 15.642259 4.300956 4.281513 9.515724 6.432503 15.643282 6.451946 47.88152-11.056823 73.658603 4.290723 77.331249 46.045709 1.237177 10.428513 0.618077 20.24816-1.855254 29.458939 0 6.148024 2.15099 11.361769 6.451946 15.643282 4.299933 4.281513 9.515724 6.432503 15.642259 6.451946L768.695337 470.110961 768.695337 470.110961zM753.052055 210.510458c-27.005051-6.147-63.22088-4.919033-108.648512 3.683902-0.607844 0-1.226944 0.303922-1.855254 0.912789l-0.912789 1.855254-0.912789 0.912789c-6.755868 1.846044-12.284791 5.685489-16.585747 11.519358-4.300956 5.833869-6.450922 12.128225-6.450922 18.883069 0 9.210779 3.072989 16.880459 9.219989 23.008017 6.147 6.128581 13.511735 9.201569 22.095227 9.219989l2.768043 0c0.608867 0 1.9934-0.303922 4.154623-0.912789 2.160199-0.607844 4.457522-1.070378 6.891967-1.384533 2.435469-0.314155 5.046946-0.932232 7.836479-1.855254 2.788509-0.923022 5.244444-1.846044 7.365758-2.769067 2.12029-0.921999 6.264681-1.384533 12.432147-1.384533 6.167466 0 13.688767 0.462534 22.565948 1.384533 8.877181 0.923022 18.697851 3.221368 29.459962 6.892991 10.763135 3.672646 21.505803 8.278547 32.229029 13.81668 10.723226 5.53711 21.465894 13.20679 32.229029 23.008017 10.763135 9.800203 20.122293 21.152762 28.075429 34.054607 15.96767 36.21583 19.041682 71.204715 9.219989 104.965633 0 0.608867-0.156566 1.227967-0.470721 1.856277-0.314155 0.62831-0.774643 2.160199-1.38351 4.595668-0.608867 2.435469-1.227967 4.732791-1.855254 6.892991-0.629333 2.160199-1.24741 4.919033-1.856277 8.278547-0.608867 3.358491-0.912789 6.274914-0.912789 8.749268 0 5.51869 1.531889 10.123568 4.596691 13.815657 3.063779 3.692089 6.904247 6.304589 11.519358 7.836479 4.615111 1.531889 9.987468 2.297322 16.115026 2.296299 17.185404 0 27.309996-10.438747 30.372751-31.31624 7.364735-23.940249 11.509125-46.801932 12.432147-68.581981 0.924045-21.782096-0.607844-40.958854-4.595668-57.534368-3.987824-16.575514-9.968026-32.072463-17.941628-46.487777-7.972579-14.415314-17.184381-26.690896-27.633361-36.823674-10.447956-10.133801-22.11467-19.34458-34.998095-27.633361-12.883425-8.287757-25.315572-14.887059-37.296441-19.796882-11.979846-4.909823-24.411993-8.896624-37.295418-11.960403L753.052055 210.508411 753.052055 210.510458z" p-id="1463"></path></svg></span><span class="username">diabloneo</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Archive diabloneo's articles.
</p>
      </div>
    </div>

  </div>

</footer>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78067453-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </body>

</html>
