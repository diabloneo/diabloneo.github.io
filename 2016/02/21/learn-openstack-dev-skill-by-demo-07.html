<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>通过demo学习OpenStack开发所需的基础知识 -- 数据库(2)</title>
  <meta name="description" content="在上一篇文章，我们介绍了SQLAlchemy的基本概念，也介绍了基本的使用流程。本文我们结合webdemo这个项目来介绍如何在项目中使用SQLAlchemy。另外，我们还会介绍数据库版本管理的概念和实践，这也是OpenStack每个项目都需要做的事情。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/2016/02/21/learn-openstack-dev-skill-by-demo-07.html">
  <link rel="alternate" type="application/rss+xml" title="Coffee, Coke and Code" href="/feed.xml">
</head>


  <body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Coffee, Coke and Code</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">通过demo学习OpenStack开发所需的基础知识 -- 数据库(2)</h1>
    <p class="post-meta"><time datetime="2016-02-21T00:00:00+08:00" itemprop="datePublished">Feb 21, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>在上一篇文章，我们介绍了SQLAlchemy的基本概念，也介绍了基本的使用流程。本文我们结合webdemo这个项目来介绍如何在项目中使用SQLAlchemy。另外，我们还会介绍数据库版本管理的概念和实践，这也是OpenStack每个项目都需要做的事情。</p>

<h1 id="webdemo中的数据模型的定义和实现">Webdemo中的数据模型的定义和实现</h1>

<p>我们之前在<a href="https://github.com/diabloneo/webdemo">webdemo</a>项目中已经开发了一个user管理的API，可以在<a href="https://segmentfault.com/a/1190000004004179">这里</a>回顾。当时只是接收了API请求并且打印信息，并没有实际的进行数据存储。现在我们就要引入数据库操作，来完成user管理的API。</p>

<h2 id="user数据模型">User数据模型</h2>

<p>在开发数据库应用前，需要先定义好数据模型。因为本文只是要演示SQLAlchemy的应用，所以我们定义个最简单的数据模型。user表的定义如下：</p>

<ul>
  <li><strong>id</strong>: 主键，一般由数据库的自增类型实现。</li>
  <li><strong>user_id</strong>: user id，是一个UUID字符串，是OpenStack中最常用来标记资源的方式，全局唯一，并且为该字段建立索引。</li>
  <li><strong>name</strong>: user的名称，允许修改，全局唯一，不能为空。</li>
  <li><strong>email</strong>: user的email，允许修改，可以为空。</li>
</ul>

<h2 id="搭建数据库层的代码框架">搭建数据库层的代码框架</h2>

<p>OpenStack项目中我见过两种数据库的代码框架分隔，一种是Keystone的风格，它把一组API的API代码和数据库代码都放在同一个目录下，如下所示：</p>

<p><img src="/assets/imgs/00004_keystone_db_code.png" alt="Keystone的数据库代码" /></p>

<p>采用Pecan框架的项目则大多把数据库相关代码都放在db目录下，比如Magnum项目，如下所示：</p>

<p><img src="/assets/imgs/00005_magnum_db_code.png" alt="Magnum的数据库代码" /></p>

<p>由于webdemo采用的是Pecan框架，而且把数据库操作的代码放到同一个目录下也会比较清晰，所以我们采用和Magnum项目相同的方式来编写数据库相关的代码，创建<strong>webdemo/db</strong>目录，然后把数据库操作的相关代码都放在这个目录下，如下所示：</p>

<p><img src="/assets/imgs/00006_webdemo_db_code.png" alt="webdemo的数据库代码" /></p>

<p>由于webdemo项目还没有使用<strong>oslo_db</strong>库，所以代码看起来比较直观，没有Magnum项目复杂。接下来，我们就要开始写数据库操作的相关代码，分为两个步骤：</p>

<ol>
  <li>在<em>db/models.py</em>中定义<code class="highlighter-rouge">User</code>类，对应数据库的user表。</li>
  <li>在<em>db/api.py</em>中实现一个<code class="highlighter-rouge">Connection</code>类，这个类封装了所有的数据库操作接口。我们会在这个类中实现对user表的CRUD等操作。</li>
</ol>

<h3 id="定义user数据模型映射类">定义User数据模型映射类</h3>

<p><em>db/models.py</em>中的代码如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Index</span>


<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="s">"""User table"""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'user'</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Index</span><span class="p">(</span><span class="s">'ix_user_user_id'</span><span class="p">,</span> <span class="s">'user_id'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span></code></pre></figure>

<p>我们按照我们之前定义的数据模型，实现了映射类。</p>

<h3 id="实现db-api">实现DB API</h3>

<h4 id="db通用函数">DB通用函数</h4>

<p>在<em>db/api.py</em>中，我们先定义了一些通用函数，代码如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">sqlalchemy.orm</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">exc</span>

<span class="kn">from</span> <span class="nn">webdemo.db</span> <span class="kn">import</span> <span class="n">models</span> <span class="k">as</span> <span class="n">db_models</span>


<span class="n">_ENGINE</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_SESSION_MAKER</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">get_engine</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_ENGINE</span>
    <span class="k">if</span> <span class="n">_ENGINE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_ENGINE</span>

    <span class="n">_ENGINE</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite://'</span><span class="p">)</span>
    <span class="n">db_models</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">_ENGINE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_ENGINE</span>


<span class="k">def</span> <span class="nf">get_session_maker</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_SESSION_MAKER</span>
    <span class="k">if</span> <span class="n">_SESSION_MAKER</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_SESSION_MAKER</span>

    <span class="n">_SESSION_MAKER</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_SESSION_MAKER</span>


<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">()</span>
    <span class="n">maker</span> <span class="o">=</span> <span class="n">get_session_maker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">maker</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">session</span></code></pre></figure>

<p>上面的代码中，我们定义了三个函数：</p>

<ul>
  <li><code class="highlighter-rouge">get_engine</code>：返回全局唯一的engine，不需要重复分配。</li>
  <li><code class="highlighter-rouge">get_session_maker</code>：返回全局唯一的session maker，不需要重复分配。</li>
  <li><code class="highlighter-rouge">get_session</code>：每次返回一个新的session，因为一个session不能同时被两个数据库客户端使用。</li>
</ul>

<p>这三个函数是使用SQLAlchemy中经常会封装的，所以OpenStack的<strong>oslo_db</strong>项目就封装了这些函数，供所有的OpenStack项目使用。</p>

<p>这里需要注意一个地方，在<code class="highlighter-rouge">get_engine()</code>中：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">    <span class="n">_ENGINE</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite://'</span><span class="p">)</span>
    <span class="n">db_models</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">_ENGINE</span><span class="p">)</span></code></pre></figure>

<p>我们使用了sqlite内存数据库，并且立刻创建了所有的表。这么做只是为了演示方便。在实际的项目中，<code class="highlighter-rouge">create_engine()</code>的数据库URL参数应该是从配置文件中读取的，而且也不能在创建engine后就创建所有的表（这样数据库的数据都丢了）。要解决在数据库中建表的问题，就要先了解数据库版本管理的知识，也就是<strong>database migration</strong>，我们在下文中会说明。</p>

<h4 id="connection实现">Connection实现</h4>

<p><code class="highlighter-rouge">Connection</code>的实现就简单得多了，直接看代码。这里只实现了<code class="highlighter-rouge">get_user()</code>和<code class="highlighter-rouge">list_users()</code>方法。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoResultFound</span><span class="p">:</span>
            <span class="c"># TODO(developer): process this situation</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">list_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">pass</span></code></pre></figure>

<h3 id="在api-controller中使用db-api">在API Controller中使用DB API</h3>

<p>现在我们有了DB API，接下来就是要在Controller中使用它。对于使用Pecan框架的应用来说，我们定义一个Pecan hook，这个hook在每个请求进来的时候实例化一个db的<code class="highlighter-rouge">Connection</code>对象，然后在controller代码中我们可以直接使用这个<code class="highlighter-rouge">Connection</code>实例。关于Pecan hook的相关信息，请查看<a href="http://pecan.readthedocs.org/en/latest/hooks.html">Pecan官方文档</a>。</p>

<p>首先，我们要实现这个hook，并且加入到app中。hook的实现代码在<em>webdemo/api/hooks.py</em>中：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pecan</span> <span class="kn">import</span> <span class="n">hooks</span>

<span class="kn">from</span> <span class="nn">webdemo.db</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">db_api</span>


<span class="k">class</span> <span class="nc">DBHook</span><span class="p">(</span><span class="n">hooks</span><span class="o">.</span><span class="n">PecanHook</span><span class="p">):</span>
    <span class="s">"""Create a db connection instance."""</span>

    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">db_api</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span></code></pre></figure>

<p>然后，修改<em>webdemo/api/app.py</em>中的<code class="highlighter-rouge">setup_app()</code>方法：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">setup_app</span><span class="p">():</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_pecan_config</span><span class="p">()</span>

    <span class="n">app_hooks</span> <span class="o">=</span> <span class="p">[</span><span class="n">hooks</span><span class="o">.</span><span class="n">DBHook</span><span class="p">()]</span>
    <span class="n">app_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">make_app</span><span class="p">(</span>
        <span class="n">app_conf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'root'</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">'logging'</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="n">hooks</span><span class="o">=</span><span class="n">app_hooks</span><span class="p">,</span>
        <span class="o">**</span><span class="n">app_conf</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span></code></pre></figure>

<p>现在，我们就可以在controller使用DB API了。我们这里要重新实现<a href="https://segmentfault.com/a/1190000004004179">API服务(4)</a>实现的<em>GET /v1/users</em>这个接口：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">...</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>


<span class="k">class</span> <span class="nc">Users</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="n">User</span><span class="p">]</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">UsersController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="nd">@pecan.expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UserController</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">remainder</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db_conn</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_conn</span>     <span class="c"># 获取DBHook中创建的Connection实例</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">list_users</span><span class="p">()</span>  <span class="c"># 调用所需的DB API</span>
        <span class="n">users_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
            <span class="n">u</span><span class="o">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="nb">id</span>
            <span class="n">u</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span>
            <span class="n">u</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
            <span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="n">users_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Users</span><span class="p">(</span><span class="n">users</span><span class="o">=</span><span class="n">users_list</span><span class="p">)</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">user</span></code></pre></figure>

<p>现在，我们就已经完整的实现了这个API，客户端访问API时是从数据库拿数据，而不是返回一个模拟的数据。读者可以使用<a href="https://segmentfault.com/a/1190000004004179">API服务(4)</a>中的方法运行测试服务器来测试这个API。注意：由于数据库操作依赖于SQLAlchemy库，所以需要把它添加到<em>requirement.txt</em>中：<strong>SQLAlchemy&lt;1.1.0,&gt;=0.9.9</strong>。</p>

<h2 id="小结">小结</h2>

<p>现在我们已经完成了数据库层的代码框架搭建，读者可以大概了解到一个OpenStack项目中是如何进行数据库操作的。上面的代码可以到<a href="https://github.com/diabloneo/webdemo">https://github.com/diabloneo/webdemo</a>下载。</p>

<h1 id="数据库版本管理">数据库版本管理</h1>

<h2 id="数据库版本管理的概念">数据库版本管理的概念</h2>

<p>上面我们在<code class="highlighter-rouge">get_engine()</code>函数中使用了内存数据库，并且创建了所有的表。在实际项目中，这么做肯定是不行的：</p>

<ol>
  <li>实际项目中不会使用内存数据库，这种数据库一般只是在单元测试中使用。</li>
  <li>如果每次<code class="highlighter-rouge">create_engine</code>都把数据库的表重新创建一次，那么数据库中的数据就丢失了，绝对不可容忍。</li>
</ol>

<p>解决这个问题的办法也很简单：<strong>不使用内存数据库，并且在运行项目代码前先把数据库中的表都建好</strong>。这么做确实是解决了问题，但是看起来有点麻烦：</p>

<ol>
  <li>如果每次都手动写SQL语句来创建数据库中的表，会很容易出错，而且很麻烦。</li>
  <li>如果项目修改了数据模型，那么不能简单的修改建表的SQL语句，因为重新建表会让数据丢失。我们只能增加新的SQL语句来修改现有的数据库。</li>
  <li><strong>最关键的是</strong>：我们怎么知道一个正在生产运行的数据库是要执行那些SQL语句？如果数据库第一次使用，那么执行全部的语句是正确的；如果数据库已经在使用，里面有数据，那么我们只能执行那些修改表定义的SQL语句，而不能执行那些重新建表的SQL语句。</li>
</ol>

<p>为了解决这种问题，就有人发明了数据库版本管理的概念，也称为<strong>Database Migration</strong>。基本原理是：<strong>在我们要使用的数据库中建立一张表，里面保存了数据库的当前版本，然后我们在代码中为每个数据库版本写好所需的SQL语句。当对一个数据库执行migration操作时，会执行从当前版本到目标版本之间的所有SQL语句</strong>。举个例子：</p>

<ol>
  <li>在<em>Version 1</em>时，我们在数据库中建立一个user表。</li>
  <li>在<em>Version 2</em>时，我们在数据库中建立一个project表。</li>
  <li>在<em>Version 3</em>时，我们修改user表，增加一个age列。</li>
</ol>

<p>那么在我们对一个数据库执行migration操作，数据库的当前版本<em>Version 1</em>，我们设定的目标版本是<em>Version 3</em>，那么操作就是：建立一个project表，修改user表，增加一个age列，并且把数据库当前版本设置为<em>Version 3</em>。</p>

<p>数据库的版本管理是所有大型数据库项目的需求，每种语言都有自己的解决方案。OpenStack中主要使用SQLAlchemy的两种解决方案：<a href="https://github.com/openstack/sqlalchemy-migrate">sqlalchemy-migrate</a>和<a href="https://alembic.readthedocs.org/en/latest/">Alembic</a>。早期的OpenStack项目使用了sqlalchemy-migrate，后来换成了Alembic。做出这个切换的主要原因是Alembic对数据库版本的设计和管理更灵活，可以支持分支，而sqlalchemy-migrate只能支持直线的版本管理，具体可以看OpenStack的WiKi文档<a href="https://wiki.openstack.org/wiki/Obsolete:Alembic">Alembic</a>。</p>

<p>接下来，我们就在我们的webdemo项目中引入Alembic来进行版本管理。</p>

<h2 id="alembic">Alembic</h2>

<p>要使用Alembic，大概需要以下步骤：</p>

<ol>
  <li>安装Alembic</li>
  <li>在项目中创建Alembic的migration环境</li>
  <li>修改Alembic配置文件</li>
  <li>创建migration脚本</li>
  <li>执行迁移动作</li>
</ol>

<p>看起来步骤很复杂，其实搭建好环境后，新增数据库版本只需要执行最后两个步骤。</p>

<h3 id="安装alembic">安装Alembic</h3>

<p>在<em>webdemo/requirements.txt</em>中加入：<strong>alembic&gt;=0.8.0</strong>。然后在virtualenv中安装即可。</p>

<h3 id="在项目中创建alembic的migration环境">在项目中创建Alembic的migration环境</h3>

<p>一般OpenStack项目中，Alembic的环境都是放在<em>db/sqlalchemy/</em>目录下，因此，我们先建立目录<em>webdemo/db/sqlalchemy/</em>，然后在这个目录下初始化Alembic环境：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo git:(master) ✗ $ cd webdemo/db
(.venv)➜ ~/programming/python/webdemo/webdemo/db git:(master) ✗ $ ls
api.py  api.pyc  __init__.py  __init__.pyc  models.py  models.pyc  sqlalchemy
(.venv)➜ ~/programming/python/webdemo/webdemo/db git:(master) ✗ $ cd sqlalchemy
(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ ls
(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ alembic init alembic
  Creating directory /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic ... done
  Creating directory /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/versions ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/script.py.mako ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic.ini ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/README ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/env.pyc ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/env.py ... done
  Please edit configuration/connection/logging settings in '/home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic.ini' before proceeding.
(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $
</code></pre>
</div>

<p>现在，我们就在<em>webdemo/db/sqlalchemy/alembic/</em>目录下建立了一个Alembic migration环境：</p>

<p><img src="/assets/imgs/00007_alembic_migration_environment.png" alt="Alembic Migration Environment" /></p>

<h3 id="修改alembic配置文件">修改Alembic配置文件</h3>

<p><em>webdemo/db/sqlalchemy/alembic.ini</em>文件是Alembic的配置文件，我们现在需要修改文件中的<strong>sqlalchemy.url</strong>这个配置项，用来指向我们的数据库。这里，我们使用SQLite数据库，数据库文件存放在webdemo项目的根目录下，名称是<strong>webdemo.db</strong>：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># sqlalchemy.url = driver://user:pass@localhost/dbname
sqlalchemy.url = sqlite:///../../../webdemo.db
</code></pre>
</div>

<p>注意：实际项目中，数据库的URL信息是从项目配置文件中读取，然后通过动态的方式传递给Alembic的。具体的做法，读者可以参考Magnum项目的实现：<a href="https://github.com/openstack/magnum/blob/master/magnum/db/sqlalchemy/migration.py">https://github.com/openstack/magnum/blob/master/magnum/db/sqlalchemy/migration.py</a>。</p>

<h3 id="创建migration脚本">创建migration脚本</h3>

<p>现在，我们可以创建第一个迁移脚本了，我们的第一个数据库版本就是创建我们的user表：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ alembic revision -m "Create user table"
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/versions/4bafdb464737_create_user_table.py ... done
</code></pre>
</div>

<p>现在脚本已经帮我们生成好了，不过这个只是一个空的脚本，我们需要自己实现里面的具体操作，补充完整后的脚本如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="s">"""Create user table

Revision ID: 4bafdb464737
Revises:
Create Date: 2016-02-21 12:24:46.640894

"""</span>

<span class="c"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s">'4bafdb464737'</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="kn">as</span> <span class="nn">sa</span>


<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s">'user'</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'email'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s">'user'</span><span class="p">)</span></code></pre></figure>

<p>其实就是把<code class="highlighter-rouge">User</code>类的定义再写了一遍，使用了Alembic提供的接口来方便的创建和删除表。</p>

<h3 id="执行迁移操作">执行迁移操作</h3>

<p>我们需要在<em>webdemo/db/sqlalchemy/</em>目录下执行迁移操作，可能需要手动指定PYTHONPATH：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ PYTHONPATH=../../../ alembic upgrade head
INFO  [alembic.migration] Context impl SQLiteImpl.
INFO  [alembic.migration] Will assume non-transactional DDL.
INFO  [alembic.migration] Running upgrade  -&gt; 4bafdb464737, Create user table
</code></pre>
</div>

<p><code class="highlighter-rouge">alembic upgrade head</code>会把数据库升级到最新的版本。这个时候，在webdemo的根目录下会出现<strong>webdemo.db</strong>这个文件，可以使用sqlite3命令查看内容：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo git:(master) ✗ $ ls
AUTHORS  build  ChangeLog  dist  LICENSE  README.md  requirements.txt  Session.vim  setup.cfg  setup.py  webdemo  webdemo.db  webdemo.egg-info
(.venv)➜ ~/programming/python/webdemo git:(master) ✗ $ sqlite3 webdemo.db
SQLite version 3.8.11.1 2015-07-29 20:00:57
Enter ".help" for usage hints.
sqlite&gt; .tables
alembic_version  user
sqlite&gt; .schema alembic_version
CREATE TABLE alembic_version (
        version_num VARCHAR(32) NOT NULL
);
sqlite&gt; .schema user
CREATE TABLE user (
        id INTEGER NOT NULL,
        user_id VARCHAR(255) NOT NULL,
        name VARCHAR(64) NOT NULL,
        email VARCHAR(255),
        PRIMARY KEY (id),
        UNIQUE (name)
);
sqlite&gt; .header on
sqlite&gt; select * from alembic_version;
version_num
4bafdb464737
</code></pre>
</div>

<h3 id="测试新的数据库">测试新的数据库</h3>

<p>现在我们可以把之前使用的内存数据库换掉，使用我们的文件数据库，修改<code class="highlighter-rouge">get_engine()</code>函数：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_engine</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_ENGINE</span>
    <span class="k">if</span> <span class="n">_ENGINE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_ENGINE</span>

    <span class="n">_ENGINE</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite:///webdemo.db'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_ENGINE</span></code></pre></figure>

<p>现在你可以手动往webdemo.db中添加数据，然后测试下API：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ ~/programming/python/webdemo git:(master) ✗ $ sqlite3 webdemo.db
SQLite version 3.8.11.1 2015-07-29 20:00:57
Enter ".help" for usage hints.
sqlite&gt; .header on
sqlite&gt; select * from user;
sqlite&gt; .schema user
CREATE TABLE user (
        id INTEGER NOT NULL,
        user_id VARCHAR(255) NOT NULL,
        name VARCHAR(64) NOT NULL,
        email VARCHAR(255),
        PRIMARY KEY (id),
        UNIQUE (name)
);
sqlite&gt; insert into user values(1, "user_id", "Alice", "alice@example.com");
sqlite&gt; select * from user;
id|user_id|name|email
1|user_id|Alice|alice@example.com
sqlite&gt; .q
➜ ~/programming/python/webdemo git:(master) ✗ $
➜ ~/programming/python/webdemo git:(master) ✗ $ curl http://localhost:8080/v1/users
{"users": [{"email": "alice@example.com", "user_id": "user_id", "id": 1, "name": "Alice"}]}% 
</code></pre>
</div>

<h3 id="小结-1">小结</h3>

<p>现在，我们就已经完成了database migration代码框架的搭建，可以成功执行了第一个版本的数据库迁移。OpenStack项目中也是这么来做数据库迁移的。后续，一旦修改了项目，需要修改数据模型时，只要新增migration脚本即可。这部分代码也可以在<a href="https://github.com/diabloneo/webdemo">https://github.com/diabloneo/webdemo</a>中看到。</p>

<p>在实际生产环境中，当我们发布了一个项目的新版本后，在上线的时候，都会自动执行数据库迁移操作，升级数据库版本到最新的版本。如果线上的数据库版本已经是最新的，那么这个操作没有任何影响；如果不是最新的，那么会把数据库升级到最新的版本。</p>

<p>关于Alembic的更多使用方法，请阅读官方文档<a href="https://alembic.readthedocs.org/en/latest/">Alembic</a>。</p>

<h1 id="总结">总结</h1>

<p>本文到这边就结束了，这两篇文章我们了解OpenStack中数据库应用开发的基础知识。接下来，我们将会了解OpenStack中单元测试的相关知识。</p>


    <br />
    <div>
      <!-- aThis Button BEGIN -->
      <div class="jiathis_style_32x32">
        <a class="jiathis_button_tsina"></a>
        <a class="jiathis_button_twitter"></a>
        <a class="jiathis_button_googleplus"></a>
        <a class="jiathis_button_weixin"></a>
        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
      </div>
      <script type="text/javascript" >
var jiathis_config={
  sm:"tsina,weixin,twitter,googleplus",
  summary:"",
  shortUrl:false,
  hideMore:true
}
      </script>
      <script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
      <!-- JiaThis Button END -->
    </div>
    <div>
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。
    </div>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Coffee, Coke and Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Coffee, Coke and Code</li>
          <li><a href="mailto:diabloneo@gmail.com">diabloneo@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/diabloneo"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">diabloneo</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/diabloneo"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">diabloneo</span></a>

          </li>
          

          
          <li>
            <a href="https://weibo.com/diabloneo"><span class="icon icon--weibo"><?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1506693756610" class="icon" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1461" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><defs><style type="text/css"></style></defs><path d="M36.795021 82.536808 36.795021 82.536808 36.795021 82.536808Z" p-id="1462"></path><path d="M704.237279 523.521404c-9.210779-1.846044-15.190981-4.604878-17.941628-8.278547-2.749624-3.672646-3.210112-7.05058-1.384533-10.133801l2.769067-4.595668c0.607844-0.608867 1.226944-1.530866 1.855254-2.769067 0.62831-1.237177 1.855254-3.848655 3.682879-7.835456 1.826602-3.987824 3.211135-7.973602 4.1536-11.961426 0.942465-3.986801 1.708921-8.895601 2.297322-14.728446 0.589424-5.832845 0.431835-11.361769-0.470721-16.58677-0.903579-5.225001-2.749624-10.900258-5.539156-17.027815-2.790556-6.127558-6.628978-11.656481-11.519358-16.585747-8.601912-8.601912-19.806091-14.129812-33.613562-16.585747-13.807471-2.454912-27.613918-2.611477-41.421388-0.470721-13.806447 2.142803-26.847461 4.901637-39.122019 8.278547-12.274558 3.377934-22.398126 6.598278-30.372751 9.664104l-11.960403 5.538133c-6.147 1.846044-11.213389 3.074012-15.201214 3.682879-3.987824 0.60989-7.060813 0.453325-9.219989-0.470721-2.160199-0.923022-3.848655-1.846044-5.068436-2.768043-1.218758-0.923022-1.680269-3.072989-1.384533-6.451946 0.296759-3.377934 0.599657-6.294356 0.912789-8.749268 0.313132-2.452865 1.078565-6.293333 2.297322-11.519358 1.217734-5.226025 2.14178-9.369392 2.768043-12.432147 0-7.364735-0.461511-14.267958-1.384533-20.709671-0.923022-6.441713-2.916423-13.649881-5.981225-21.623483-3.063779-7.973602-7.512091-14.415314-13.345959-19.326161-5.833869-4.910846-13.198603-8.896624-22.095227-11.960403-8.896624-3.063779-20.406772-3.986801-34.527374-2.769067-14.121626 1.218758-30.079062 4.900613-47.873334 11.04659-21.485337 7.364735-43.275619 18.254759-65.369823 32.67212-22.094204 14.415314-41.273009 29.449729-57.534368 45.101197-16.261359 15.652492-31.149441 30.843472-44.661176 45.573965-13.511735 14.731516-23.950482 26.701129-31.315216 35.912931l-10.133801 14.728446c-20.249183 26.397207-35.282574 52.79339-45.102221 79.187527-9.819646 26.396183-14.424524 46.340421-13.81668 59.83476l0 19.326161c3.693112 29.458939 12.746302 55.855122 27.161616 79.187527 14.415314 23.331381 31.599695 42.205241 51.55519 56.620555 19.955494 14.415314 43.434232 26.689872 70.437236 36.82572 27.004027 10.133801 52.937676 17.498536 77.804017 22.095227 24.864294 4.595668 51.103912 7.816013 78.716806 9.664104 45.426609 3.692089 92.533486 0.166799 141.317563-10.57587 48.786123-10.744715 94.202499-29.313629 136.25322-55.708789 42.049698-26.396183 71.666226-58.006112 88.849584-94.830809 10.429537-21.48636 15.800871-41.74373 16.116049-60.776202 0.315178-19.031449-2.907213-34.527374-9.664104-46.486754-6.756891-11.960403-15.507182-22.546505-26.248827-31.758308-10.741645-9.211802-20.866237-15.968693-30.372751-20.268626-9.506515-4.299933-17.941628-7.059789-25.305339-8.278547L704.237279 523.521404 704.237279 523.521404zM423.455361 809.841455c-66.284659 3.064802-122.592083-9.829879-168.924317-38.680974-46.330188-28.851095-69.495794-65.370847-69.494771-109.561301 0-43.579541 23.01825-81.170694 69.053726-112.772436 46.036499-31.600719 102.500489-48.942689 169.394015-52.02591 66.893526-3.082198 123.358539 7.964392 169.392992 33.141818 46.036499 25.177426 69.053726 59.546188 69.053726 103.108333 0 44.190455-23.478737 83.931574-70.438259 119.224382-46.958498 35.291784-102.962 54.470589-168.009482 57.533344L423.455361 809.841455 423.455361 809.841455zM396.765489 554.806945c-17.793248 1.846044-33.750685 5.990434-47.873334 12.432147-14.121626 6.442736-25.168216 13.807471-33.140795 22.095227-7.972579 8.28878-14.728446 17.185404-20.268626 26.689872-5.539156 9.505491-9.378601 18.86465-11.519358 28.075429-2.140757 9.210779-3.524267 17.646915-4.1536 25.306362-0.630357 7.659447-0.933255 13.638625-0.913812 17.940604l0.913812 7.365758 0 3.682879c0 1.846044 0.618077 5.5279 1.855254 11.04659 1.237177 5.519714 2.925632 10.587126 5.067412 15.202237 2.14178 4.615111 5.66707 9.682523 10.57587 15.201214 4.909823 5.51869 10.743692 10.124592 17.499559 13.81668 40.517809 19.639293 78.264505 25.619494 113.243157 17.940604 34.977629-7.67889 63.209624-25.324782 84.695984-52.937676 8.601912-10.428513 14.278191-23.322172 17.028838-38.680974s2.131547-30.853705-1.855254-46.486754c-3.987824-15.634072-10.891048-29.90203-20.709671-42.805922-9.818623-12.902868-24.39255-22.880103-43.719734-29.930683-19.326161-7.05058-41.577954-9.045003-66.756403-5.981225L396.765489 554.806945 396.765489 554.806945zM363.621625 728.827327c-3.692089 0.607844-7.217379 0.765433-10.57587 0.470721-3.358491-0.293689-6.431479-0.913812-9.219989-1.855254-2.789533-0.941442-5.548366-2.01182-8.278547-3.210112-2.729158-1.197268-5.027503-2.885723-6.892991-5.067412-1.864464-2.180666-3.553942-4.331655-5.067412-6.451946-1.51347-2.12029-2.741437-4.576225-3.682879-7.364735-0.942465-2.790556-1.403976-5.705955-1.384533-8.749268 0-6.756891 1.846044-13.355169 5.538133-19.796882 3.692089-6.441713 8.759501-11.970636 15.201214-16.58677 6.441713-4.615111 13.649881-7.227612 21.624507-7.836479 5.51869-0.607844 10.890025-0.451278 16.115026 0.471744 5.225001 0.921999 9.673313 2.453888 13.345959 4.595668 3.672646 2.14178 6.894014 4.596691 9.664104 7.365758 2.77009 2.768043 4.76349 5.989411 5.981225 9.66308 1.216711 3.674693 1.835811 7.661494 1.855254 11.961426 0 6.755868-1.9934 13.19758-5.981225 19.325138-3.986801 6.128581-9.358135 11.343349-16.115026 15.643282-6.756891 4.299933-14.121626 6.755868-22.095227 7.365758L363.621625 728.827327 363.621625 728.827327zM441.86771 662.542668c-4.300956 3.063779-8.750291 4.448312-13.346983 4.1536-4.595668-0.294712-7.816013-2.288113-9.66308-5.981225l-1.856277-3.682879c-0.607844-1.237177-0.912789-2.465145-0.912789-3.682879l0-3.682879c0-1.846044 0.304945-3.377934 0.912789-4.596691l1.856277-3.682879c0.607844-1.237177 1.530866-2.160199 2.768043-2.768043l2.768043-3.682879c4.910846-3.693112 9.664104-5.225001 14.258749-4.596691 4.595668 0.629333 7.816013 3.084245 9.664104 7.365758 1.845021 2.454912 2.610454 5.214768 2.296299 8.278547-0.314155 3.063779-1.237177 5.980201-2.768043 8.749268-1.531889 2.769067-3.52529 5.380544-5.981225 7.835456L441.86771 662.542668 441.86771 662.542668zM768.695337 470.110961c3.692089 0 7.071046-0.923022 10.133801-2.769067 3.063779-1.845021 5.51869-4.143367 7.364735-6.891967 1.847068-2.750647 3.075035-5.66707 3.682879-8.749268 0.608867-0.608867 0.913812-1.531889 0.913812-2.769067 7.363711-69.976748-17.186428-109.874433-73.650417-119.695103-16.576537-3.063779-31.925107-3.367701-46.045709-0.912789-4.300956 0-7.983835 1.070378-11.04659 3.210112-3.063779 2.140757-5.676279 4.898567-7.836479 8.278547-2.160199 3.377934-3.230578 6.904247-3.210112 10.57587 0 6.147 2.15099 11.360745 6.451946 15.642259 4.300956 4.281513 9.515724 6.432503 15.643282 6.451946 47.88152-11.056823 73.658603 4.290723 77.331249 46.045709 1.237177 10.428513 0.618077 20.24816-1.855254 29.458939 0 6.148024 2.15099 11.361769 6.451946 15.643282 4.299933 4.281513 9.515724 6.432503 15.642259 6.451946L768.695337 470.110961 768.695337 470.110961zM753.052055 210.510458c-27.005051-6.147-63.22088-4.919033-108.648512 3.683902-0.607844 0-1.226944 0.303922-1.855254 0.912789l-0.912789 1.855254-0.912789 0.912789c-6.755868 1.846044-12.284791 5.685489-16.585747 11.519358-4.300956 5.833869-6.450922 12.128225-6.450922 18.883069 0 9.210779 3.072989 16.880459 9.219989 23.008017 6.147 6.128581 13.511735 9.201569 22.095227 9.219989l2.768043 0c0.608867 0 1.9934-0.303922 4.154623-0.912789 2.160199-0.607844 4.457522-1.070378 6.891967-1.384533 2.435469-0.314155 5.046946-0.932232 7.836479-1.855254 2.788509-0.923022 5.244444-1.846044 7.365758-2.769067 2.12029-0.921999 6.264681-1.384533 12.432147-1.384533 6.167466 0 13.688767 0.462534 22.565948 1.384533 8.877181 0.923022 18.697851 3.221368 29.459962 6.892991 10.763135 3.672646 21.505803 8.278547 32.229029 13.81668 10.723226 5.53711 21.465894 13.20679 32.229029 23.008017 10.763135 9.800203 20.122293 21.152762 28.075429 34.054607 15.96767 36.21583 19.041682 71.204715 9.219989 104.965633 0 0.608867-0.156566 1.227967-0.470721 1.856277-0.314155 0.62831-0.774643 2.160199-1.38351 4.595668-0.608867 2.435469-1.227967 4.732791-1.855254 6.892991-0.629333 2.160199-1.24741 4.919033-1.856277 8.278547-0.608867 3.358491-0.912789 6.274914-0.912789 8.749268 0 5.51869 1.531889 10.123568 4.596691 13.815657 3.063779 3.692089 6.904247 6.304589 11.519358 7.836479 4.615111 1.531889 9.987468 2.297322 16.115026 2.296299 17.185404 0 27.309996-10.438747 30.372751-31.31624 7.364735-23.940249 11.509125-46.801932 12.432147-68.581981 0.924045-21.782096-0.607844-40.958854-4.595668-57.534368-3.987824-16.575514-9.968026-32.072463-17.941628-46.487777-7.972579-14.415314-17.184381-26.690896-27.633361-36.823674-10.447956-10.133801-22.11467-19.34458-34.998095-27.633361-12.883425-8.287757-25.315572-14.887059-37.296441-19.796882-11.979846-4.909823-24.411993-8.896624-37.295418-11.960403L753.052055 210.508411 753.052055 210.510458z" p-id="1463"></path></svg></span><span class="username">diabloneo</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Archive diabloneo's articles.
</p>
      </div>
    </div>

  </div>

</footer>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78067453-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </body>

</html>
