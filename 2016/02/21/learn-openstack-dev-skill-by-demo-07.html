<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>通过demo学习OpenStack开发所需的基础知识 -- 数据库(2)</title>
  <meta name="description" content="在上一篇文章，我们介绍了SQLAlchemy的基本概念，也介绍了基本的使用流程。本文我们结合webdemo这个项目来介绍如何在项目中使用SQLAlchemy。另外，我们还会介绍数据库版本管理的概念和实践，这也是OpenStack每个项目都需要做的事情。">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="/2016/02/21/learn-openstack-dev-skill-by-demo-07.html">
  <link rel="alternate" type="application/rss+xml" title="Coffee, Coke and Code" href="/feed.xml">
</head>


  <body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Coffee, Coke and Code</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">通过demo学习OpenStack开发所需的基础知识 -- 数据库(2)</h1>
    <p class="post-meta"><time datetime="2016-02-21T00:00:00+08:00" itemprop="datePublished">Feb 21, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>在上一篇文章，我们介绍了SQLAlchemy的基本概念，也介绍了基本的使用流程。本文我们结合webdemo这个项目来介绍如何在项目中使用SQLAlchemy。另外，我们还会介绍数据库版本管理的概念和实践，这也是OpenStack每个项目都需要做的事情。</p>

<h1 id="webdemo中的数据模型的定义和实现">Webdemo中的数据模型的定义和实现</h1>

<p>我们之前在<a href="https://github.com/diabloneo/webdemo">webdemo</a>项目中已经开发了一个user管理的API，可以在<a href="https://segmentfault.com/a/1190000004004179">这里</a>回顾。当时只是接收了API请求并且打印信息，并没有实际的进行数据存储。现在我们就要引入数据库操作，来完成user管理的API。</p>

<h2 id="user数据模型">User数据模型</h2>

<p>在开发数据库应用前，需要先定义好数据模型。因为本文只是要演示SQLAlchemy的应用，所以我们定义个最简单的数据模型。user表的定义如下：</p>

<ul>
  <li><strong>id</strong>: 主键，一般由数据库的自增类型实现。</li>
  <li><strong>user_id</strong>: user id，是一个UUID字符串，是OpenStack中最常用来标记资源的方式，全局唯一，并且为该字段建立索引。</li>
  <li><strong>name</strong>: user的名称，允许修改，全局唯一，不能为空。</li>
  <li><strong>email</strong>: user的email，允许修改，可以为空。</li>
</ul>

<h2 id="搭建数据库层的代码框架">搭建数据库层的代码框架</h2>

<p>OpenStack项目中我见过两种数据库的代码框架分隔，一种是Keystone的风格，它把一组API的API代码和数据库代码都放在同一个目录下，如下所示：</p>

<p><img src="/assets/imgs/00004_keystone_db_code.png" alt="Keystone的数据库代码" /></p>

<p>采用Pecan框架的项目则大多把数据库相关代码都放在db目录下，比如Magnum项目，如下所示：</p>

<p><img src="/assets/imgs/00005_magnum_db_code.png" alt="Magnum的数据库代码" /></p>

<p>由于webdemo采用的是Pecan框架，而且把数据库操作的代码放到同一个目录下也会比较清晰，所以我们采用和Magnum项目相同的方式来编写数据库相关的代码，创建<strong>webdemo/db</strong>目录，然后把数据库操作的相关代码都放在这个目录下，如下所示：</p>

<p><img src="/assets/imgs/00006_webdemo_db_code.png" alt="webdemo的数据库代码" /></p>

<p>由于webdemo项目还没有使用<strong>oslo_db</strong>库，所以代码看起来比较直观，没有Magnum项目复杂。接下来，我们就要开始写数据库操作的相关代码，分为两个步骤：</p>

<ol>
  <li>在<em>db/models.py</em>中定义<code class="highlighter-rouge">User</code>类，对应数据库的user表。</li>
  <li>在<em>db/api.py</em>中实现一个<code class="highlighter-rouge">Connection</code>类，这个类封装了所有的数据库操作接口。我们会在这个类中实现对user表的CRUD等操作。</li>
</ol>

<h3 id="定义user数据模型映射类">定义User数据模型映射类</h3>

<p><em>db/models.py</em>中的代码如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Index</span>


<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="s">"""User table"""</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">'user'</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Index</span><span class="p">(</span><span class="s">'ix_user_user_id'</span><span class="p">,</span> <span class="s">'user_id'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span></code></pre></figure>

<p>我们按照我们之前定义的数据模型，实现了映射类。</p>

<h3 id="实现db-api">实现DB API</h3>

<h4 id="db通用函数">DB通用函数</h4>

<p>在<em>db/api.py</em>中，我们先定义了一些通用函数，代码如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">sqlalchemy.orm</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">exc</span>

<span class="kn">from</span> <span class="nn">webdemo.db</span> <span class="kn">import</span> <span class="n">models</span> <span class="k">as</span> <span class="n">db_models</span>


<span class="n">_ENGINE</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">_SESSION_MAKER</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">get_engine</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_ENGINE</span>
    <span class="k">if</span> <span class="n">_ENGINE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_ENGINE</span>

    <span class="n">_ENGINE</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite://'</span><span class="p">)</span>
    <span class="n">db_models</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">_ENGINE</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_ENGINE</span>


<span class="k">def</span> <span class="nf">get_session_maker</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_SESSION_MAKER</span>
    <span class="k">if</span> <span class="n">_SESSION_MAKER</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_SESSION_MAKER</span>

    <span class="n">_SESSION_MAKER</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_SESSION_MAKER</span>


<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">()</span>
    <span class="n">maker</span> <span class="o">=</span> <span class="n">get_session_maker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">maker</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">session</span></code></pre></figure>

<p>上面的代码中，我们定义了三个函数：</p>

<ul>
  <li><code class="highlighter-rouge">get_engine</code>：返回全局唯一的engine，不需要重复分配。</li>
  <li><code class="highlighter-rouge">get_session_maker</code>：返回全局唯一的session maker，不需要重复分配。</li>
  <li><code class="highlighter-rouge">get_session</code>：每次返回一个新的session，因为一个session不能同时被两个数据库客户端使用。</li>
</ul>

<p>这三个函数是使用SQLAlchemy中经常会封装的，所以OpenStack的<strong>oslo_db</strong>项目就封装了这些函数，供所有的OpenStack项目使用。</p>

<p>这里需要注意一个地方，在<code class="highlighter-rouge">get_engine()</code>中：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">    <span class="n">_ENGINE</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite://'</span><span class="p">)</span>
    <span class="n">db_models</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">_ENGINE</span><span class="p">)</span></code></pre></figure>

<p>我们使用了sqlite内存数据库，并且立刻创建了所有的表。这么做只是为了演示方便。在实际的项目中，<code class="highlighter-rouge">create_engine()</code>的数据库URL参数应该是从配置文件中读取的，而且也不能在创建engine后就创建所有的表（这样数据库的数据都丢了）。要解决在数据库中建表的问题，就要先了解数据库版本管理的知识，也就是<strong>database migration</strong>，我们在下文中会说明。</p>

<h4 id="connection实现">Connection实现</h4>

<p><code class="highlighter-rouge">Connection</code>的实现就简单得多了，直接看代码。这里只实现了<code class="highlighter-rouge">get_user()</code>和<code class="highlighter-rouge">list_users()</code>方法。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoResultFound</span><span class="p">:</span>
            <span class="c"># TODO(developer): process this situation</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">list_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">db_models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">update_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">pass</span></code></pre></figure>

<h3 id="在api-controller中使用db-api">在API Controller中使用DB API</h3>

<p>现在我们有了DB API，接下来就是要在Controller中使用它。对于使用Pecan框架的应用来说，我们定义一个Pecan hook，这个hook在每个请求进来的时候实例化一个db的<code class="highlighter-rouge">Connection</code>对象，然后在controller代码中我们可以直接使用这个<code class="highlighter-rouge">Connection</code>实例。关于Pecan hook的相关信息，请查看<a href="http://pecan.readthedocs.org/en/latest/hooks.html">Pecan官方文档</a>。</p>

<p>首先，我们要实现这个hook，并且加入到app中。hook的实现代码在<em>webdemo/api/hooks.py</em>中：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pecan</span> <span class="kn">import</span> <span class="n">hooks</span>

<span class="kn">from</span> <span class="nn">webdemo.db</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">db_api</span>


<span class="k">class</span> <span class="nc">DBHook</span><span class="p">(</span><span class="n">hooks</span><span class="o">.</span><span class="n">PecanHook</span><span class="p">):</span>
    <span class="s">"""Create a db connection instance."""</span>

    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">db_conn</span> <span class="o">=</span> <span class="n">db_api</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span></code></pre></figure>

<p>然后，修改<em>webdemo/api/app.py</em>中的<code class="highlighter-rouge">setup_app()</code>方法：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">setup_app</span><span class="p">():</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_pecan_config</span><span class="p">()</span>

    <span class="n">app_hooks</span> <span class="o">=</span> <span class="p">[</span><span class="n">hooks</span><span class="o">.</span><span class="n">DBHook</span><span class="p">()]</span>
    <span class="n">app_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">pecan</span><span class="o">.</span><span class="n">make_app</span><span class="p">(</span>
        <span class="n">app_conf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'root'</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">'logging'</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="n">hooks</span><span class="o">=</span><span class="n">app_hooks</span><span class="p">,</span>
        <span class="o">**</span><span class="n">app_conf</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span></code></pre></figure>

<p>现在，我们就可以在controller使用DB API了。我们这里要重新实现<a href="https://segmentfault.com/a/1190000004004179">API服务(4)</a>实现的<em>GET /v1/users</em>这个接口：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">...</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">wtypes</span><span class="o">.</span><span class="n">text</span>


<span class="k">class</span> <span class="nc">Users</span><span class="p">(</span><span class="n">wtypes</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="n">User</span><span class="p">]</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">UsersController</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">RestController</span><span class="p">):</span>

    <span class="nd">@pecan.expose</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="o">*</span><span class="n">remainder</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">UserController</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="n">remainder</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db_conn</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_conn</span>     <span class="c"># 获取DBHook中创建的Connection实例</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">list_users</span><span class="p">()</span>  <span class="c"># 调用所需的DB API</span>
        <span class="n">users_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
            <span class="n">u</span><span class="o">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="nb">id</span>
            <span class="n">u</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">user_id</span>
            <span class="n">u</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>
            <span class="n">u</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="n">users_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Users</span><span class="p">(</span><span class="n">users</span><span class="o">=</span><span class="n">users_list</span><span class="p">)</span>

    <span class="nd">@expose.expose</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">user</span></code></pre></figure>

<p>现在，我们就已经完整的实现了这个API，客户端访问API时是从数据库拿数据，而不是返回一个模拟的数据。读者可以使用<a href="https://segmentfault.com/a/1190000004004179">API服务(4)</a>中的方法运行测试服务器来测试这个API。注意：由于数据库操作依赖于SQLAlchemy库，所以需要把它添加到<em>requirement.txt</em>中：<strong>SQLAlchemy&lt;1.1.0,&gt;=0.9.9</strong>。</p>

<h2 id="小结">小结</h2>

<p>现在我们已经完成了数据库层的代码框架搭建，读者可以大概了解到一个OpenStack项目中是如何进行数据库操作的。上面的代码可以到<a href="https://github.com/diabloneo/webdemo">https://github.com/diabloneo/webdemo</a>下载。</p>

<h1 id="数据库版本管理">数据库版本管理</h1>

<h2 id="数据库版本管理的概念">数据库版本管理的概念</h2>

<p>上面我们在<code class="highlighter-rouge">get_engine()</code>函数中使用了内存数据库，并且创建了所有的表。在实际项目中，这么做肯定是不行的：</p>

<ol>
  <li>实际项目中不会使用内存数据库，这种数据库一般只是在单元测试中使用。</li>
  <li>如果每次<code class="highlighter-rouge">create_engine</code>都把数据库的表重新创建一次，那么数据库中的数据就丢失了，绝对不可容忍。</li>
</ol>

<p>解决这个问题的办法也很简单：<strong>不使用内存数据库，并且在运行项目代码前先把数据库中的表都建好</strong>。这么做确实是解决了问题，但是看起来有点麻烦：</p>

<ol>
  <li>如果每次都手动写SQL语句来创建数据库中的表，会很容易出错，而且很麻烦。</li>
  <li>如果项目修改了数据模型，那么不能简单的修改建表的SQL语句，因为重新建表会让数据丢失。我们只能增加新的SQL语句来修改现有的数据库。</li>
  <li><strong>最关键的是</strong>：我们怎么知道一个正在生产运行的数据库是要执行那些SQL语句？如果数据库第一次使用，那么执行全部的语句是正确的；如果数据库已经在使用，里面有数据，那么我们只能执行那些修改表定义的SQL语句，而不能执行那些重新建表的SQL语句。</li>
</ol>

<p>为了解决这种问题，就有人发明了数据库版本管理的概念，也称为<strong>Database Migration</strong>。基本原理是：<strong>在我们要使用的数据库中建立一张表，里面保存了数据库的当前版本，然后我们在代码中为每个数据库版本写好所需的SQL语句。当对一个数据库执行migration操作时，会执行从当前版本到目标版本之间的所有SQL语句</strong>。举个例子：</p>

<ol>
  <li>在<em>Version 1</em>时，我们在数据库中建立一个user表。</li>
  <li>在<em>Version 2</em>时，我们在数据库中建立一个project表。</li>
  <li>在<em>Version 3</em>时，我们修改user表，增加一个age列。</li>
</ol>

<p>那么在我们对一个数据库执行migration操作，数据库的当前版本<em>Version 1</em>，我们设定的目标版本是<em>Version 3</em>，那么操作就是：建立一个project表，修改user表，增加一个age列，并且把数据库当前版本设置为<em>Version 3</em>。</p>

<p>数据库的版本管理是所有大型数据库项目的需求，每种语言都有自己的解决方案。OpenStack中主要使用SQLAlchemy的两种解决方案：<a href="https://github.com/openstack/sqlalchemy-migrate">sqlalchemy-migrate</a>和<a href="https://alembic.readthedocs.org/en/latest/">Alembic</a>。早期的OpenStack项目使用了sqlalchemy-migrate，后来换成了Alembic。做出这个切换的主要原因是Alembic对数据库版本的设计和管理更灵活，可以支持分支，而sqlalchemy-migrate只能支持直线的版本管理，具体可以看OpenStack的WiKi文档<a href="https://wiki.openstack.org/wiki/Obsolete:Alembic">Alembic</a>。</p>

<p>接下来，我们就在我们的webdemo项目中引入Alembic来进行版本管理。</p>

<h2 id="alembic">Alembic</h2>

<p>要使用Alembic，大概需要以下步骤：</p>

<ol>
  <li>安装Alembic</li>
  <li>在项目中创建Alembic的migration环境</li>
  <li>修改Alembic配置文件</li>
  <li>创建migration脚本</li>
  <li>执行迁移动作</li>
</ol>

<p>看起来步骤很复杂，其实搭建好环境后，新增数据库版本只需要执行最后两个步骤。</p>

<h3 id="安装alembic">安装Alembic</h3>

<p>在<em>webdemo/requirements.txt</em>中加入：<strong>alembic&gt;=0.8.0</strong>。然后在virtualenv中安装即可。</p>

<h3 id="在项目中创建alembic的migration环境">在项目中创建Alembic的migration环境</h3>

<p>一般OpenStack项目中，Alembic的环境都是放在<em>db/sqlalchemy/</em>目录下，因此，我们先建立目录<em>webdemo/db/sqlalchemy/</em>，然后在这个目录下初始化Alembic环境：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo git:(master) ✗ $ cd webdemo/db
(.venv)➜ ~/programming/python/webdemo/webdemo/db git:(master) ✗ $ ls
api.py  api.pyc  __init__.py  __init__.pyc  models.py  models.pyc  sqlalchemy
(.venv)➜ ~/programming/python/webdemo/webdemo/db git:(master) ✗ $ cd sqlalchemy
(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ ls
(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ alembic init alembic
  Creating directory /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic ... done
  Creating directory /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/versions ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/script.py.mako ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic.ini ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/README ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/env.pyc ... done
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/env.py ... done
  Please edit configuration/connection/logging settings in '/home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic.ini' before proceeding.
(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $
</code></pre>
</div>

<p>现在，我们就在<em>webdemo/db/sqlalchemy/alembic/</em>目录下建立了一个Alembic migration环境：</p>

<p><img src="/assets/imgs/00007_alembic_migration_environment.png" alt="Alembic Migration Environment" /></p>

<h3 id="修改alembic配置文件">修改Alembic配置文件</h3>

<p><em>webdemo/db/sqlalchemy/alembic.ini</em>文件是Alembic的配置文件，我们现在需要修改文件中的<strong>sqlalchemy.url</strong>这个配置项，用来指向我们的数据库。这里，我们使用SQLite数据库，数据库文件存放在webdemo项目的根目录下，名称是<strong>webdemo.db</strong>：</p>

<div class="highlighter-rouge"><pre class="highlight"><code># sqlalchemy.url = driver://user:pass@localhost/dbname
sqlalchemy.url = sqlite:///../../../webdemo.db
</code></pre>
</div>

<p>注意：实际项目中，数据库的URL信息是从项目配置文件中读取，然后通过动态的方式传递给Alembic的。具体的做法，读者可以参考Magnum项目的实现：<a href="https://github.com/openstack/magnum/blob/master/magnum/db/sqlalchemy/migration.py">https://github.com/openstack/magnum/blob/master/magnum/db/sqlalchemy/migration.py</a>。</p>

<h3 id="创建migration脚本">创建migration脚本</h3>

<p>现在，我们可以创建第一个迁移脚本了，我们的第一个数据库版本就是创建我们的user表：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ alembic revision -m "Create user table"
  Generating /home/diabloneo/programming/python/webdemo/webdemo/db/sqlalchemy/alembic/versions/4bafdb464737_create_user_table.py ... done
</code></pre>
</div>

<p>现在脚本已经帮我们生成好了，不过这个只是一个空的脚本，我们需要自己实现里面的具体操作，补充完整后的脚本如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="s">"""Create user table

Revision ID: 4bafdb464737
Revises:
Create Date: 2016-02-21 12:24:46.640894

"""</span>

<span class="c"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s">'4bafdb464737'</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">from</span> <span class="nn">alembic</span> <span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="kn">as</span> <span class="nn">sa</span>


<span class="k">def</span> <span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s">'user'</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'user_id'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">'email'</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s">'user'</span><span class="p">)</span></code></pre></figure>

<p>其实就是把<code class="highlighter-rouge">User</code>类的定义再写了一遍，使用了Alembic提供的接口来方便的创建和删除表。</p>

<h3 id="执行迁移操作">执行迁移操作</h3>

<p>我们需要在<em>webdemo/db/sqlalchemy/</em>目录下执行迁移操作，可能需要手动指定PYTHONPATH：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo/webdemo/db/sqlalchemy git:(master) ✗ $ PYTHONPATH=../../../ alembic upgrade head
INFO  [alembic.migration] Context impl SQLiteImpl.
INFO  [alembic.migration] Will assume non-transactional DDL.
INFO  [alembic.migration] Running upgrade  -&gt; 4bafdb464737, Create user table
</code></pre>
</div>

<p><code class="highlighter-rouge">alembic upgrade head</code>会把数据库升级到最新的版本。这个时候，在webdemo的根目录下会出现<strong>webdemo.db</strong>这个文件，可以使用sqlite3命令查看内容：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(.venv)➜ ~/programming/python/webdemo git:(master) ✗ $ ls
AUTHORS  build  ChangeLog  dist  LICENSE  README.md  requirements.txt  Session.vim  setup.cfg  setup.py  webdemo  webdemo.db  webdemo.egg-info
(.venv)➜ ~/programming/python/webdemo git:(master) ✗ $ sqlite3 webdemo.db
SQLite version 3.8.11.1 2015-07-29 20:00:57
Enter ".help" for usage hints.
sqlite&gt; .tables
alembic_version  user
sqlite&gt; .schema alembic_version
CREATE TABLE alembic_version (
        version_num VARCHAR(32) NOT NULL
);
sqlite&gt; .schema user
CREATE TABLE user (
        id INTEGER NOT NULL,
        user_id VARCHAR(255) NOT NULL,
        name VARCHAR(64) NOT NULL,
        email VARCHAR(255),
        PRIMARY KEY (id),
        UNIQUE (name)
);
sqlite&gt; .header on
sqlite&gt; select * from alembic_version;
version_num
4bafdb464737
</code></pre>
</div>

<h3 id="测试新的数据库">测试新的数据库</h3>

<p>现在我们可以把之前使用的内存数据库换掉，使用我们的文件数据库，修改<code class="highlighter-rouge">get_engine()</code>函数：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_engine</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_ENGINE</span>
    <span class="k">if</span> <span class="n">_ENGINE</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_ENGINE</span>

    <span class="n">_ENGINE</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">'sqlite:///webdemo.db'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_ENGINE</span></code></pre></figure>

<p>现在你可以手动往webdemo.db中添加数据，然后测试下API：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>➜ ~/programming/python/webdemo git:(master) ✗ $ sqlite3 webdemo.db
SQLite version 3.8.11.1 2015-07-29 20:00:57
Enter ".help" for usage hints.
sqlite&gt; .header on
sqlite&gt; select * from user;
sqlite&gt; .schema user
CREATE TABLE user (
        id INTEGER NOT NULL,
        user_id VARCHAR(255) NOT NULL,
        name VARCHAR(64) NOT NULL,
        email VARCHAR(255),
        PRIMARY KEY (id),
        UNIQUE (name)
);
sqlite&gt; insert into user values(1, "user_id", "Alice", "alice@example.com");
sqlite&gt; select * from user;
id|user_id|name|email
1|user_id|Alice|alice@example.com
sqlite&gt; .q
➜ ~/programming/python/webdemo git:(master) ✗ $
➜ ~/programming/python/webdemo git:(master) ✗ $ curl http://localhost:8080/v1/users
{"users": [{"email": "alice@example.com", "user_id": "user_id", "id": 1, "name": "Alice"}]}% 
</code></pre>
</div>

<h3 id="小结-1">小结</h3>

<p>现在，我们就已经完成了database migration代码框架的搭建，可以成功执行了第一个版本的数据库迁移。OpenStack项目中也是这么来做数据库迁移的。后续，一旦修改了项目，需要修改数据模型时，只要新增migration脚本即可。这部分代码也可以在<a href="https://github.com/diabloneo/webdemo">https://github.com/diabloneo/webdemo</a>中看到。</p>

<p>在实际生产环境中，当我们发布了一个项目的新版本后，在上线的时候，都会自动执行数据库迁移操作，升级数据库版本到最新的版本。如果线上的数据库版本已经是最新的，那么这个操作没有任何影响；如果不是最新的，那么会把数据库升级到最新的版本。</p>

<p>关于Alembic的更多使用方法，请阅读官方文档<a href="https://alembic.readthedocs.org/en/latest/">Alembic</a>。</p>

<h1 id="总结">总结</h1>

<p>本文到这边就结束了，这两篇文章我们了解OpenStack中数据库应用开发的基础知识。接下来，我们将会了解OpenStack中单元测试的相关知识。</p>


    <br />
    <div>
      <!-- aThis Button BEGIN -->
      <div class="jiathis_style_32x32">
        <a class="jiathis_button_tsina"></a>
        <a class="jiathis_button_twitter"></a>
        <a class="jiathis_button_googleplus"></a>
        <a class="jiathis_button_weixin"></a>
        <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
      </div>
      <script type="text/javascript" >
var jiathis_config={
  sm:"tsina,weixin,twitter,googleplus",
  summary:"",
  shortUrl:false,
  hideMore:true
}
      </script>
      <script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
      <!-- JiaThis Button END -->
    </div>
    <div>
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。
    </div>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Coffee, Coke and Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Coffee, Coke and Code</li>
          <li><a href="mailto:diabloneo@gmail.com">diabloneo@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/diabloneo"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">diabloneo</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/diabloneo"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">diabloneo</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>

</footer>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78067453-1', 'auto');
  ga('send', 'pageview');

</script>

    
  </body>

</html>
