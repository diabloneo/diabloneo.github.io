<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>如何使用 top 命令</title>
  <meta name="description" content="top 命令是 Linux 下最常用的系统监控命令。默认执行 top 命令之后，我们就能看到系统的许多监控指标，也可以看到进程按照 CPU 利用率从高到低排列。但是，这个只是 top 命令的最简单用法，其实 top 可以进行很多的定制。">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/pygments-rainbow_dash.css">
  <link rel="canonical" href="http://diabloneo.github.io//2019/08/29/How-to-use-top-command/">
  <link rel="alternate" type="application/rss+xml" title="Coffee, Coke and Code" href="http://diabloneo.github.io//feed.xml">
</head>


  <body>
    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Coffee, Coke and Code</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/tags">Tags</a>
        <a class="page-link" href="/feed.xml">RSS</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">如何使用 top 命令</h1>
    <p class="post-meta"><time datetime="2019-08-29T00:00:00+08:00" itemprop="datePublished">Aug 29, 2019</time></p>
  </header>

  <div class="post-tags">
    <ul>
      
      <li>
        <a href="/tags/linux/">linux</a>
      </li>
      
    </ul>
  </div>

  <div class="post-content" itemprop="articleBody">
    
      <!-- Go to www.addthis.com/dashboard to customize your tools -->
      <div class="addthis_inline_share_toolbox"></div>
    
    <br />
      <p><strong>top</strong> 命令是 Linux 下最常用的系统监控命令。默认执行 top 命令之后，我们就能看到系统的许多监控指标，也可以看到进程按照 CPU 利用率从高到低排列。但是，这个只是 top 命令的最简单用法，其实 top 可以进行很多的定制。</p>

<h2 id="top-界面模式">top 界面模式</h2>

<p>top 的界面其实有两个模式：<strong>full-screen mode</strong> 和 <strong>alternate-display mode</strong>，根据实际的效果来看，这两个模式就是<strong>全屏模式</strong>和<strong>多窗口模式</strong>。不做任何定制的时候，我们看到的就是全屏模式。如下图所示：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00021_top_cmd_1.png" alt="top_cmd_1" /></p>

<h3 id="full-screen-mode">full-screen mode</h3>

<p>全屏模式时，整个界面分为两个部分：<strong>summary area</strong> 和 <strong>tasks area</strong>，如上图所示。</p>

<h3 id="alternate-display-mode">alternate-display mode</h3>

<p>多窗口模式的界面如下：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00022_top_cmd_2.png" alt="top_cmd_2" /></p>

<p>要进入多窗口模式，在全屏模式下，按 <strong>A</strong> 即可（这个可以在两个模式间来回切换）。多窗口模式有一个 summary area 和 4 个 window，4 个窗口从上到下编号，对应 1 到 4。summary area 默认为 window 1 的 summary area，可以切换为不同 window 的 summary area，这个可以从 summary area 左上角的提示看出来。这个提示区会展示 summary area 当前对应的 window 的编号和名字，比如 <strong>1:Def</strong>。要切换 summary area 对应不同的 window，可以按 <strong>a</strong> （从上到下） 或者 <strong>w</strong> （从下到上）。</p>

<p>top 默认定义了 4 个 window，这里先给出名字和编号，其他的下文再详述：</p>

<ol>
  <li>Def</li>
  <li>Job</li>
  <li>Mem</li>
  <li>Usr</li>
</ol>

<h4 id="field-group">Field Group</h4>

<p>top 其实有两个概念是混合使用的，就是 window 和 Field Group，你可以认为他们就是等价的，本文除了这一小节，后面都使用 window 这个术语。。上面提到了，top 默认定义了 4 个 window，每个 window 配置要显示的列，就称为这个 window 的 <strong>Field Group</strong>。在全屏模式下，可以通过快捷键 <strong>g</strong> 切换当前要显示的 Field Group 是哪个，使用序号 1 到 4 到进行选择。修改当前展示的 Field Group 不仅是修改了要显示的内容，<strong>样式也会使用 window 的配置，包括过滤器和颜色配置等</strong>。</p>

<p>在多窗口模式下，快捷键 <strong>g</strong> 就对应到切换 window，效果和 <strong>a</strong> <strong>w</strong> 是一样的。在多窗口模式下，快捷键 <strong>G</strong> 用来修改 window 的名字。</p>

<h3 id="界面的滚动和定位">界面的滚动和定位</h3>

<p>在任何一个 window 下，或者全屏模式下，top 都支持如下快捷键来进行界面的滚动：</p>

<ul>
  <li><strong>Up</strong> or <strong>alt+k</strong></li>
  <li><strong>Down</strong> or <strong>alt+j</strong></li>
  <li><strong>Left</strong></li>
  <li><strong>Right</strong></li>
  <li><strong>PgUp</strong></li>
  <li><strong>PgDown</strong></li>
  <li><strong>Home</strong></li>
  <li><strong>End</strong></li>
</ul>

<p>上面这些和大多数应用是一样的，就不展开说了。这里要说的是，top 支持显示一个定位信息，你可以看到自己现在处于第几行，第几个字段，通过快捷键 <strong>C</strong> 切换：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00026_top_cmd_6.png" alt="top_cmd_6" /></p>

<p>这个定位信息，也很容易看，<em>y</em> 表示当前的第一行是第几个 task 以及一共有几个 task；<em>x</em> 表示当前的第一列是第几列，以及一共有多少列。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scroll coordinates: y = 1/145 (tasks), x = 1/12 (fields)
</code></pre></div></div>

<h2 id="summary-area">Summary Area</h2>

<p>Summary area 展示了系统的全局监控信息，如下所示。整个区域从上到下分为 3 个部分： <strong>load average</strong>, <strong>tasks and cpu</strong>, <strong>memory</strong>。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
top - 14:24:54 up 26 days, 22:13,  1 user,  load average: 0.08, 0.05, 0.05        # load average
Tasks: 145 total,   1 running, 144 sleeping,   0 stopped,   0 zombie              # tasks and cpu
%Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st   # tasks and cpu
KiB Mem : 12138004 total,  2857072 free,   548312 used,  8732620 buff/cache       # memory
KiB Swap:        0 total,        0 free,        0 used.  7757480 avail Mem        # memory
</code></pre></div></div>

<h3 id="load-average">Load average</h3>

<p><em>Load average</em> 部分主要展示系统的负载。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
#     Now      Uptime              User     Load average
#                                  count                  1m    5m    15m
top - 14:24:54 up 26 days, 22:13,  1 user,  load average: 0.08, 0.05, 0.05
</code></pre></div></div>

<p>如下快捷键可以用来控制这个区域：</p>

<ul>
  <li><strong>l</strong>(lower case L): 切换是否显示。</li>
</ul>

<h3 id="tasks-and-cpu">Tasks and CPU</h3>

<p><em>Tasks</em> 部分主要展示系统的进程数或者线程数（根据 threads-mode 来决定）。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
#      Total        State      State           State        State
#      tasks or     running    sleeping        stopped      zombie
#      threads
Tasks: 145 total,   1 running, 144 sleeping,   0 stopped,   0 zombie
</code></pre></div></div>

<p><em>CPU</em> 的部分主要是展示不同状态的任务的 CPU 消耗占比：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%Cpu(s):  0.2 us,  0.2 sy,  0.0 ni, 99.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</code></pre></div></div>

<p>具体的缩写含义如下：</p>

<ul>
  <li><strong>us</strong>: user, time running un-niced user processes, 普通进程的 CPU 消耗占比。</li>
  <li><strong>sy</strong>: system, time running kernel processes, 内核任务的 CPU 消耗占比。</li>
  <li><strong>ni</strong>: nice, time running niced user processes, 高优先级进程的 CPU 消耗占比。</li>
  <li><strong>id</strong>: idle, time spent in the kernel idle handler, 空闲时间占比。</li>
  <li><strong>wa</strong>: IO-wait, time waiting for I/O completion, 等待 IO 完成的 CPU 消耗占比（进程处于 D 状态）。</li>
  <li><strong>hi</strong>: time spent servicing hardware interrupts, 用于处理硬中断的 CPU 消耗占比。</li>
  <li><strong>si</strong>: time spent servicing software interrupts, 用于处理软中断的 CPU 消耗占比。</li>
  <li><strong>st</strong>: time stolen from this vm by the hypervisor, 虚拟机管理进程从这个虚拟机偷走的 CPU 资源。</li>
</ul>

<p>如下快捷键可以用来控制这个区域：</p>

<ul>
  <li><strong>t</strong>: 切换 CPU 部分的展示方式，例如数值还是进度条，也可以切换到关闭这个区域。</li>
  <li><strong>1</strong>(digit one): 切换单个 CPU 和总体 CPU 的显示。</li>
  <li><strong>2</strong>: 按照 NUMA Node 展示。</li>
  <li><strong>3</strong>: 展示指定 NUMA Node 下的所有 CPU。</li>
  <li><strong>H</strong>: 显示线程显示，默认是进程。</li>
</ul>

<h3 id="memory">Memory</h3>

<p>*Memory** 的部分展示了系统的内存信息和交换分区的信息。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
KiB Mem : 12138004 total,  2857072 free,   548312 used,  8732620 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  7757480 avail Mem
</code></pre></div></div>

<ul>
  <li><strong>total</strong>: 总内存大小。</li>
  <li><strong>free</strong>: 空闲内存大小。</li>
  <li><strong>used</strong>: 已使用内存大小。</li>
  <li><strong>buff/cache</strong>: block buffer + page cache 所占用的内存大小。</li>
  <li><strong>avail Mem</strong>: 这个值是系统的估算值，表示可用于启动新程序的物理内存大小（不包括 swap 空间）。</li>
</ul>

<p>如下快捷键可以用来控制这个区域：</p>

<ul>
  <li><strong>m</strong>: 切换 memory 部分的展示方式，例如数值还是进度条，也可以切换到关闭这个区域。</li>
  <li><strong>E</strong>: 切换内存单位。</li>
</ul>

<h2 id="tasks-area">Tasks Area</h2>

<p>Tasks area 包含两个部分：字段名称和任务列表（根据指定的字段排序）。这里我们先介绍全屏模式下 tasks area，多窗口模式的 tasks area 后面介绍。。对于 tasks area，最主要考虑的是如下几个问题：</p>

<ol>
  <li>要显示哪些字段？要根据哪个字段排序？升序还是降序？</li>
  <li>是否只展示符合某些条件的任务？</li>
</ol>

<h3 id="要展示哪些字段要根据哪个字段排序">要展示哪些字段？要根据哪个字段排序？</h3>

<p>top 其实可以展示很多内容，我们可以定义要展示哪些字段。在全屏模式下，按 <strong>F</strong> 进入字段管理界面，如下：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00023_top_cmd_3.png" alt="top_cmd_3" /></p>

<p>首先要注意的是第一行，这个界面可以为 4 个 window 分别设置要展示的字段，最上面一行提示当前正在为哪个 window 设置字段，以及当前使用的排序字段是哪个。同样的，可以通过可以按 <strong>a</strong> 或者 <strong>w</strong> 来切换 window。然后可以上下移动到想要处理的字段，按空格或者 <strong>d</strong> 切换是否展示，按 <strong>s</strong> 设置用该字段进行排序，按 <strong>q</strong> 或者 ESC 退出这个界面。前面型号的表示选中。要调整字段的排列顺序，先选中一个字段，按右键表示开始移动，然后上下移动，然后按左键表示移动结束。</p>

<p>下面来看下可用的字段。</p>

<h4 id="进程身份相关">进程身份相关</h4>

<ul>
  <li><strong>COMMAND</strong>:  Command Name/Line</li>
  <li><strong>PID</strong>:  Process Id</li>
  <li><strong>ENVIRON</strong>:  Environment vars</li>
  <li><strong>USER</strong>:  Effective User Name</li>
  <li><strong>PPID</strong>:  Parent Process pid</li>
  <li><strong>UID</strong>:  Effective User Id</li>
  <li><strong>RUID</strong>:  Real User Id</li>
  <li><strong>RUSER</strong>:  Real User Name</li>
  <li><strong>SUID</strong>:  Saved User Id</li>
  <li><strong>SUSER</strong>:  Saved User Name</li>
  <li><strong>GID</strong>:  Group Id</li>
  <li><strong>GROUP</strong>:  Group Name</li>
  <li><strong>PGRP</strong>:  Process Group Id</li>
  <li><strong>TTY</strong>:  Controlling Tty</li>
  <li><strong>TPGID</strong>:  Tty Process Grp Id</li>
  <li><strong>SID</strong>:  Session Id</li>
  <li><strong>SUPGIDS</strong>:  Supp Groups IDs</li>
  <li><strong>SUPGRPS</strong>:  Supp Groups Names</li>
  <li><strong>TGID</strong>:  Thread Group Id</li>
</ul>

<p>如下快捷键可以用来控制这些字段：</p>

<ul>
  <li><strong>c</strong>: 用于切换 COMMAND 列的内容是 command line 还是 program name。</li>
</ul>

<h4 id="进程状态相关">进程状态相关</h4>

<ul>
  <li><strong>S</strong>:  Process Status</li>
  <li><strong>%CPU</strong>:  CPU Usage</li>
  <li><strong>nTH</strong>:  Number of Threads</li>
  <li><strong>P</strong>:  Last Used Cpu (SMP)</li>
  <li><strong>TIME</strong>:  CPU Time。任务从启动到现在使用的 CPU 时间。</li>
  <li><strong>TIME+</strong>:  CPU Time, hundredths。任务从启动到现在使用的 CPU 时间，精确到百分之一秒。</li>
  <li><strong>WCHAN</strong>:  Sleeping in Function。对于 sleeping 的进程，当前所处的内核函数。</li>
  <li><strong>Flags</strong>:  Task Flags <sched.h></sched.h></li>
</ul>

<p>进程状态有如下几种：</p>

<ul>
  <li><strong>D</strong> Uninterruptible sleep。不可中断休眠，就是等待 I/O 完成时的状态，会导致 CPU 统计的 wa 上升。</li>
  <li><strong>R</strong> Running</li>
  <li><strong>S</strong> Sleeping</li>
  <li><strong>T</strong> Stopped by job control signal</li>
  <li><strong>t</strong> Stopped by debugger during trace</li>
  <li><strong>Z</strong> zombie</li>
</ul>

<p>如下快捷键可以用来控制这些字段：</p>

<ul>
  <li><strong>I</strong> (upper case i): 切换 %CPU 的模式，Irix/Solaris 两个模式。Irix mode 的计算方式是跑满一个 CPU 为 100%，%CPU 可能会超过 100%。Solaris mode 则是会把总体利用率除以 CPU 核数，保证不会超过 100%。</li>
  <li><strong>S</strong>: Cumulative time，off 展示两次刷新时间的即时值，而不是从进程启动到现在的累加值。</li>
</ul>

<h4 id="进程优先级相关">进程优先级相关</h4>

<ul>
  <li><strong>NI</strong>:  Nice Value. 进程的优先级。这个是表示进程的用户态优先级，范围是 -20 到 +19，默认值是 0，值越低优先级越高。</li>
  <li><strong>PR</strong>:  Priority. 进程的调度优先级，这个是内核实际使用的任务的优先级，范围是 0 到 39，映射到内核的值是 100 到 139；也可以是 rt ，表示实时任务。内核表示一个 task 的优先级的范围是 0 到 139。其中，0 到 99 是实时进程的优先级，100 到 139 是非实时进程的优先级。PR 的默认值是 20，对应到内核是 120，和 NI 的关系是: PR = 20 + NI。</li>
</ul>

<h4 id="内存相关">内存相关</h4>

<ul>
  <li><strong>%MEM</strong>:  Memory Usage (RES)</li>
  <li><strong>VIRT</strong>:  Virtual Image (KiB)。表示一个任务使用的虚拟内存总和，包括所有的代码段、数据段、链接的共享库、已经被 swap 的页和已经被映射但是没有使用的页。</li>
  <li><strong>RES</strong>:  Resident Size (KiB)。表示一个任务使用的没有被 swap 的物理内存。</li>
  <li><strong>SHR</strong>:  Shared Memory (KiB)。表示一个任务可能和其他任务共享的内存。</li>
  <li><strong>SWAP</strong>:  Swapped Size (KiB)。表示一个任务的非驻留内存，也就是使用的交换空间。</li>
  <li><strong>CODE</strong>:  Code Size (KiB)。表示任务的代码段的大小。</li>
  <li><strong>DATA</strong>:  Data+Stack (KiB)。Data Resident Set size，包括了程序数据段和栈。</li>
  <li><strong>USED</strong>:  Res+Swap Size (KiB)。就是 RES + SWAP。</li>
  <li><strong>nDRT</strong>:  Dirty Pages Count。该 task 内存空间中的脏页的数量。</li>
  <li><strong>nMaj</strong>:  Major Page Faults。该 task 遇到的 Major Page Faults 的数量。Major Page Fault 是指需要访问通过访问 swap 分区或者硬盘（mmap 一个文件，但是还没把内容读取到内存时）来处理的缺页异常。</li>
  <li><strong>nMin</strong>:  Minor Page Faults。该 task 遇到的 Minor Page Faults 的数量。Minor Page Fault 是指不需要通过访问 swap 分区或者硬盘来处理的缺页异常，简单的说，没用到磁盘 I/O。</li>
  <li><strong>vMj</strong>:  Major Faults delta。上次 top 刷新数据依赖的 Major Page Faults 增加数量。</li>
  <li><strong>vMn</strong>:  Minor Faults delta。上次 top 刷新数据依赖的 Minor Page Faults 增加数量。</li>
</ul>

<p>如下快捷键可以用来控制这些字段：</p>

<ul>
  <li><strong>e</strong>: 切换内存单位。</li>
</ul>

<h4 id="cgroup-相关">CGroup 相关</h4>

<ul>
  <li><strong>CGROUPS</strong>:  Control Groups</li>
  <li><strong>nsIPC</strong>:  IPC namespace Inode</li>
  <li><strong>nsMNT</strong>:  MNT namespace Inode</li>
  <li><strong>nsNET</strong>:  NET namespace Inode</li>
  <li><strong>nsPID</strong>:  PID namespace Inode</li>
  <li><strong>nsUSER</strong>:  USER namespace Inode</li>
  <li><strong>nsUTS</strong>:  UTS namespace Inode</li>
</ul>

<h3 id="是否只展示符合某些条件的任务">是否只展示符合某些条件的任务？</h3>

<p>这个问题，也就是如何过滤，只展示某些任务。也许你用过 <strong>htop</strong>，知道 htop 可以和方便的根据名称来过滤。top 其实也可以，而且可以根据很多字段来过滤。</p>

<h4 id="只展示非空闲的任务">只展示非空闲的任务</h4>

<p>快捷键 <strong>i</strong> 用来切换是否只展示非空闲任务。</p>

<h4 id="限制展示任务的数量">限制展示任务的数量</h4>

<p>快捷键 <strong>n</strong> 用于限制要展示的任务的数量，0 表示无限制。默认是全部展示（超过一页需要翻页）。</p>

<h4 id="只展示指定用户的任务">只展示指定用户的任务</h4>

<p>快捷键 <strong>u</strong> 表示要过滤的用户，可以加 <strong>!</strong> 前缀表示反向条件。可以输入 UID 或者 username，直接回车表示取消这个过滤条件。</p>

<h4 id="根据其他条件过滤">根据其他条件过滤</h4>

<p>top 提供了 <strong>Other Filter</strong> 的功能，通过快捷键 <strong>o</strong> (大小写不敏感) 或者 <strong>O</strong> (大小写敏感) 来启用。过滤条件的格式如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{!}Field-Name?include-if-value
              exclude-if-value
</code></pre></div></div>

<ul>
  <li><strong>!</strong> 表示非，不是必选字段，其他都是必填字段。</li>
  <li><strong>Field-Name</strong> 表示字段名字，前文已经列出。注意，这里是大小写敏感的，要完全一致。</li>
  <li><strong>?</strong> 代表一个要求的分隔符和操作符(=, &lt;, &gt;):
    <ul>
      <li><strong>&lt;</strong> 或者 <strong>&gt;</strong> 表示字符串比较，或者数值比较。注意比较时的数字的单位问题，100.0m 会比 1.0g 大，所以需要先进行单位切换（例如内存的单位切换，e）</li>
      <li><strong>=</strong> 表示部分匹配</li>
    </ul>
  </li>
</ul>

<p>可以使用多个条件进行过滤，每个按一次 o 或者 O 输入一个条件，所有条件会进行与操作。可以按 <strong>Ctrl-o</strong> 显示所有条件。</p>

<p>还有两个清理操作：</p>

<ul>
  <li><strong>=</strong>  reset filtering in current window</li>
  <li><strong>+</strong>  reset filtering in all windows</li>
</ul>

<p>举些例子：</p>

<ol>
  <li>过滤 nice 值小于 0 的任务，即以减号开头的 nice 值：<code class="highlighter-rouge">NI=-</code>。</li>
  <li>过滤所有 postgres 进程：<code class="highlighter-rouge">COMMAND=postgres</code>。</li>
</ol>

<h4 id="搜索">搜索</h4>

<p>搜索和过滤不一样，搜索不考虑字段，会在 tasks area 显示的所有内容中找到指定的行。快捷键 <strong>L</strong> 用于输入要搜索的关键字，<strong>&amp;</strong> 表示跳转到下一个匹配项。搜索关键字会被高亮，除了使用 <strong>&amp;</strong> 以外，你也需要使用 PgUp 和 PgDown 等来调整展示的内容。</p>

<h3 id="其他定制">其他定制</h3>

<ul>
  <li><strong>R</strong> 切换排序的方向，默认是从高到底，可以切换为从低到高。</li>
  <li><strong>x</strong> 切换是否高亮显示排序列。</li>
  <li><strong>y</strong> 切换是否高亮显示 running 的 task。</li>
  <li><strong>b</strong> bold/reverse，这个快捷键用于切换关键位置是粗体展示还是反色展示，会影响到 x, y 的展示效果，也会影响到 summary area 的 CPU 进度条 和 memory 进度条的展示效果。</li>
  <li><strong>d</strong> 定时刷新间隔，默认是 3s。</li>
</ul>

<p><strong>V</strong> 切换成森林视图，也就是展示进程父子关系。这个模式下无法按照字段排序。效果如下图：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00024_top_cmd_4.png" alt="top_cmd_4" /></p>

<p>有时候不想看层级太深的任务，可以使用 other filter。除了第二级是一个空格，往下的每一级都是每级三个空格，最后再加上一个反引号开头。所以要过滤掉第三级以下的，可以使用如下条件（COMMAND=后面跟7个空格）：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>!COMMAND=       `
</code></pre></div></div>

<h2 id="界面颜色">界面颜色</h2>

<p>为了更清晰的进行监控，定制颜色也是很有用的。可以按快捷键 <strong>Z</strong> 进入颜色定制界面，如下图所示：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00025_top_cmd_5.png" alt="top_cmd_5" /></p>

<p>首先可以看到上半部表示了当前正在设置哪个窗口，然后下半部有 1 2 3 三个步骤：</p>

<ol>
  <li>选择要定制的区域：
    <ol>
      <li><strong>S</strong>: Summary Data</li>
      <li><strong>M</strong>: Messages/Prompts</li>
      <li><strong>H</strong>: Column Heads</li>
      <li><strong>T</strong>: Task Information</li>
    </ol>
  </li>
  <li>给选定的区域选择一个颜色，用数字 0 到 7 对应 8 个颜色。</li>
  <li><strong>q</strong> 取消颜色设置，<strong>a</strong> 或者 <strong>g</strong> 提交颜色设置并且切换到下个窗口进行设置，回车提交颜色设置并且退出这个界面。</li>
</ol>

<p>在 top 界面上，可以通过快捷键 <strong>z</strong> 来切换是否使用颜色。</p>

<h2 id="配置文件">配置文件</h2>

<p>上面讲的这些定制，都可以保存到一个配置文件，然后 top 每次启动都会载入它所找到的配置文件。配置文件中会保存一些全局模式，比如 Irix mode 的配置，刷新时间等，也会保存每个窗口的字段配置和颜色配置等，还会保存 inspect entries （见下文）。</p>

<p>生成配置文件的方式很简单，在你完成想要的定制后，按快捷键 <strong>W</strong> 即可。CentOS 7 上，配置文件的保存路径是 <em>/root/.toprc</em>；Ubuntu 上则是 <em>~/.config/procps/toprc</em>，每次你保存的时候，top 会显示这个路径。</p>

<h2 id="inspect-mode">Inspect Mode</h2>

<p>top 有一个模式，可以允许你执行指定的命令来查看一个任务的更多信息，这个模式可以称为 <strong>Inspect Mode</strong>，通过快捷键 <strong>Y</strong> 可以进入这个模式，top 会提示你输入一个要 inspect 的 PID。不过，要使用这个模式，你需要先定义可以使用的 inspect entries，否则 top 不会进入这个模式。下面是一个最简单的配置，可以先体会下这个配置是如何写的：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[root@user ~]# cat .toprc
top's Config File (Linux processes with windows)
Id:i, Mode_altscr=0, Mode_irixps=1, Delay_time=3.0, Curwin=0
Def     fieldscur=ķ&amp;')*+,-./012568&lt;&gt;?ABCFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=195892, sortindx=18, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=5, msgsclr=1, headclr=3, taskclr=4
Job     fieldscur=(Ļ@&lt;)*+,-./012568&gt;?ABCFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=193844, sortindx=0, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=6, msgsclr=6, headclr=7, taskclr=6
Mem     fieldscur=&lt;MBND34&amp;'()*+,-./0125689FGHIJKLOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=193844, sortindx=21, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=5, msgsclr=5, headclr=4, taskclr=5
Usr     fieldscur=)+,-./1234568;&lt;=&gt;?@ABCFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=193844, sortindx=3, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=3, msgsclr=3, headclr=2, taskclr=3
Fixed_widest=0, Summ_mscale=0, Task_mscale=0, Zero_suppress=0

pipe    Open Files      lsof -P -p %d 2&gt;&amp;1
</code></pre></div></div>

<p>上面的最后一行就是就是一个 inspect entry，表示获取进程打开的文件列表。使用这个配置文件后，打开 top，按 <strong>Y</strong> 进入 inspect 模式，效果如下：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00027_top_cmd_7.png" alt="top_cmd_7" /></p>

<p>在这个界面，可以左右选择你自定义的 entry，然后回车就可以执行。比如上面这个 <em>Open Files</em> 执行后的效果如下，和直接使用 <em>lsof</em> 命令的效果一样：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00028_top_cmd_8.png" alt="top_cmd_8" /></p>

<p>在上面这个界面，可以使用 PgUp, PgDown, Home, End 等进行滚动，也可以使用 <em>less</em> 命令的语法（ <code class="highlighter-rouge">/</code> 表示搜索）。</p>

<p>下面来看 entry 的定制语法。</p>

<p>首先，<strong>#</strong> 开头的行是被注释掉的。</p>

<p>一行 inspect entry 包含三个部分： <strong>type</strong>, <strong>name</strong>, <strong>fmts</strong>，每个部分之间使用制表符 <code class="highlighter-rouge">\t</code> 分隔。</p>

<ul>
  <li><strong>type</strong>: 可以是 <em>file</em> 或者 <em>pipe</em>。<em>file</em> 就是打开一个文件，读它的内容。<em>pipe</em> 就是用 <code class="highlighter-rouge">popen</code> 接口执行命令，然后获取输出。</li>
  <li><strong>name</strong>: 名字，比如你上面看到的 <em>Open Files</em>。</li>
  <li><strong>fmts</strong>：一个文件路径，或者一行命令。这个部分可以使用变量 <code class="highlighter-rouge">%d</code> 表示 PID，比如 <code class="highlighter-rouge">/proc/%d/numa_maps</code> 或者 <code class="highlighter-rouge">lsof -P -p %d 2&gt;&amp;1</code>。</li>
</ul>

<h2 id="我的定制">我的定制</h2>

<p>效果如下：</p>

<p><img src="http://diabloneo.github.io//assets/imgs/00029_top_cmd_9.png" alt="top_cmd_9" /></p>

<p>我在 CentOS 7 下的定制文件如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>top's Config File (Linux processes with windows)
Id:i, Mode_altscr=0, Mode_irixps=1, Delay_time=3.0, Curwin=0
Cpu     fieldscur=ķ9')*+,-./0126&lt;&gt;?ABCFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=195380, sortindx=18, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=4, msgsclr=1, headclr=3, taskclr=4
Mem     fieldscur=&amp;97(34D')*+,-./012568&gt;?FGHIJKLOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=195380, sortindx=21, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=6, msgsclr=6, headclr=3, taskclr=6
Sch     fieldscur=:;&lt;=&gt;?@AMBNC&amp;'()*+,-./0128HIJKLOPQRSTUVWXYZ[\]^_`abcdefghij
        winflags=194868, sortindx=0, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=5, msgsclr=5, headclr=3, taskclr=5
Cgp     fieldscur=*097:D)+,-./1234568;&lt;=&gt;?@ABCFGIJKLMNOVWXYZ[\]^_`abcdefghij
        winflags=194868, sortindx=0, maxtasks=0, graph_cpus=0, graph_mems=0
        summclr=2, msgsclr=3, headclr=3, taskclr=2
Fixed_widest=0, Summ_mscale=0, Task_mscale=0, Zero_suppress=0

pipe    NetFiles        lsof -a -l -n -P -i4 -p %d 2&gt;&amp;1
pipe    OpenFiles       lsof -a -l -n -P -p %d 2&gt;&amp;1
file    NUMAInfo        /proc/%d/numa_maps
</code></pre></div></div>

<p>主要是定制了 4 个 window 的字段和颜色，还有 3 个 inspect entries：</p>

<ol>
  <li>CPU (sort by %CPU): PID, PPID, USER, PR, NI, VIRT, RES, SHR, S, %CPU, %MEM, TIME+, COMMAND</li>
  <li>Mem (sort by %MEM): PID, VIRT, RES, SHR, SWAP, nDRT, nMaj, nMin, vMj, vMn, %MEM, COMMAND</li>
  <li>Sche (sort by PID): PID, nTH, PR, NI, Flags,  S, P, %CPU, TIME+, COMMAND, WCHAN</li>
  <li>CGROUP (sort by PID): PID, PPID,UID, USER, CGROUPS, nsIPC, nsMNT, nsNET, nsPID, nsUSER, nsUTS, COMMAND</li>
</ol>

<p>如果要直接使用的话，用 base64 解码下面的内容，直接从网页上拷贝会有字符问题：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dG9wJ3MgQ29uZmlnIEZpbGUgKExpbnV4IHByb2Nlc3NlcyB3aXRoIHdpbmRvd3MpCklkOmksIE1v
ZGVfYWx0c2NyPTAsIE1vZGVfaXJpeHBzPTEsIERlbGF5X3RpbWU9My4wLCBDdXJ3aW49MApDcHUJ
ZmllbGRzY3VyPaWmqLWztLu9wMS3urg5xScpKissLS4vMDEyNjw+P0FCQ0ZHSElKS0xNTk9QUVJT
VFVWV1hZWltcXV5fYGFiY2RlZmdoaWoKCXdpbmZsYWdzPTE5NTM4MCwgc29ydGluZHg9MTgsIG1h
eHRhc2tzPTAsIGdyYXBoX2NwdXM9MCwgZ3JhcGhfbWVtcz0wCglzdW1tY2xyPTQsIG1zZ3NjbHI9
MSwgaGVhZGNscj0zLCB0YXNrY2xyPTQKTWVtCWZpZWxkc2N1cj2lu73AvMPBws3OJjk3uigzNEQn
xSkqKywtLi8wMTI1Njg+P0ZHSElKS0xPUFFSU1RVVldYWVpbXF1eX2BhYmNkZWZnaGlqCgl3aW5m
bGFncz0xOTUzODAsIHNvcnRpbmR4PTIxLCBtYXh0YXNrcz0wLCBncmFwaF9jcHVzPTAsIGdyYXBo
X21lbXM9MAoJc3VtbWNscj02LCBtc2dzY2xyPTYsIGhlYWRjbHI9MywgdGFza2Nscj02ClNjaAlm
aWVsZHNjdXI9pTo7PD0+P0BBTUJOQ7WztMfEtre5xcYmJygpKissLS4vMDEyOEhJSktMT1BRUlNU
VVZXWFlaW1xdXl9gYWJjZGVmZ2hpagoJd2luZmxhZ3M9MTk0ODY4LCBzb3J0aW5keD0wLCBtYXh0
YXNrcz0wLCBncmFwaF9jcHVzPTAsIGdyYXBoX21lbXM9MAoJc3VtbWNscj01LCBtc2dzY2xyPTUs
IGhlYWRjbHI9MywgdGFza2Nscj01CkNncAlmaWVsZHNjdXI9paanqCowOTc6RCkrLC0uLzEyMzQ1
Njg7PD0+P0BBQkNGR8hJSktMTU5P0NHS09TVxVZXWFlaW1xdXl9gYWJjZGVmZ2hpagoJd2luZmxh
Z3M9MTk0ODY4LCBzb3J0aW5keD0wLCBtYXh0YXNrcz0wLCBncmFwaF9jcHVzPTAsIGdyYXBoX21l
bXM9MAoJc3VtbWNscj0yLCBtc2dzY2xyPTMsIGhlYWRjbHI9MywgdGFza2Nscj0yCkZpeGVkX3dp
ZGVzdD0wLCBTdW1tX21zY2FsZT0wLCBUYXNrX21zY2FsZT0wLCBaZXJvX3N1cHByZXNzPTAKCnBp
cGUJTmV0RmlsZXMJbHNvZiAtYSAtbCAtbiAtUCAtaTQgLXAgJWQgMj4mMQpwaXBlCU9wZW5GaWxl
cwlsc29mIC1hIC1sIC1uIC1QIC1wICVkIDI+JjEKZmlsZQlOVU1BSW5mbwkvcHJvYy8lZC9udW1h
X21hcHMK
</code></pre></div></div>

    <br />

    <div>
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png" /></a>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。
    </div>

    <br />
    
      <!-- Go to www.addthis.com/dashboard to customize your tools -->
      <div class="addthis_inline_share_toolbox"></div>
    
  </div>

  
    <div class="post-comment">
      
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
  this.page.url = "http://diabloneo.github.io/2019/08/29/How-to-use-top-command/"; // <--- use canonical URL
  this.page.identifier = "/2019/08/29/How-to-use-top-command";
};
(function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');

  s.src = 'https://coffee-coke-and-code.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


    </div>
  

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Coffee, Coke and Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Coffee, Coke and Code</li>
          <li><a href="mailto:diabloneo@gmail.com">diabloneo@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <i class="fa fa-github"></i>
            <a href="https://github.com/diabloneo">
              <span class="username">diabloneo</span>
            </a>
          </li>
          

          
          <li>
            <i class="fa fa-twitter"></i>
            <a href="https://twitter.com/diabloneo">
              <span class="username">diabloneo</span>
            </a>
          </li>
          

          
          <li>
            <i class="fa fa-weibo"></i>
            <a href="https://weibo.com/diabloneo">
              <span class="username">diabloneo</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Archive diabloneo's articles.
</p>
      </div>
    </div>

  </div>

</footer>

    
      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78067453-1', 'auto');
  ga('send', 'pageview');

</script>

    
    
      <!-- Go to www.addthis.com/dashboard to customize your tools -->
      <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-59e59696a86877c1"></script> 
    
  </body>

</html>
